{% extends "base.html" %}
{% block title %}Ù…Ø³Ù†Ø¬Ø± â€” {{ username }}{% endblock %}
{% block extra_css %}
.messenger-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - var(--safe-top) - var(--safe-bottom));
    height: calc(100dvh - var(--safe-top) - var(--safe-bottom));
    max-height: 800px;
    margin: 0 auto;
    max-width: 640px;
    background: var(--surface);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}
.msg-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    padding-left: max(1rem, var(--safe-top));
    padding-right: max(1rem, var(--safe-top));
    border-bottom: 1px solid var(--border);
    background: var(--bg-soft);
    min-height: 56px;
}
.msg-header .back-btn {
    display: none;
    min-width: 44px;
    min-height: 44px;
    padding: 0;
    border-radius: var(--radius-sm);
    color: var(--text);
}
.msg-header .back-btn.visible { display: inline-flex; }
.msg-header .title { flex: 1; font-weight: 600; font-size: 1rem; }
.msg-header .header-link { font-size: 0.85rem; padding: 0.4rem 0.75rem; text-decoration: none; }
.msg-header .header-link:hover { text-decoration: none; }
.open-chat-bar {
    padding: 1rem;
    padding-left: max(1rem, var(--safe-top));
    padding-right: max(1rem, var(--safe-top));
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}
.open-chat-bar label { margin: 0; font-size: 0.9rem; }
.open-chat-bar input[type="text"] { width: 140px; max-width: 180px; }
.open-chat-bar .open-error { color: var(--danger); width: 100%; font-size: 0.85rem; margin-top: 0.25rem; }
.chat-body { flex: 1; display: flex; flex-direction: column; min-height: 0; }
.chat-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
}
.chat-placeholder .history-section {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem 1rem;
    -webkit-overflow-scrolling: touch;
}
.chat-placeholder .history-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-soft);
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}
.chat-placeholder .history-search {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}
.chat-placeholder .history-search input { flex: 1; max-width: 200px; margin: 0; }
.chat-with { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
.chat-with .btn-sm { padding: 0.35rem 0.65rem; font-size: 0.8rem; }
.msg { position: relative; }
.msg .msg-del { position: absolute; left: 0; top: 0; padding: 0.2rem 0.4rem; font-size: 0.75rem; opacity: 0.8; }
.msg .msg-read { font-size: 0.7rem; margin-top: 0.15rem; }
.chat-placeholder .history-list { list-style: none; margin: 0; padding: 0; }
.chat-placeholder .history-item {
    display: block;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    margin-bottom: 0.35rem;
    background: var(--bg-soft);
    border: 1px solid var(--border);
    cursor: pointer;
    text-align: right;
    transition: background 0.15s;
}
.chat-placeholder .history-item:hover { background: var(--surface-hover); }
.chat-placeholder .history-item .h-username { font-weight: 600; margin-bottom: 0.2rem; }
.chat-placeholder .history-item .h-preview { font-size: 0.85rem; color: var(--text-soft); }
.chat-placeholder .history-item .h-time { font-size: 0.75rem; color: var(--text-soft); margin-top: 0.25rem; }
.chat-placeholder .history-empty {
    color: var(--text-soft);
    padding: 2rem 1rem;
    text-align: center;
    line-height: 1.7;
}
.chat-active { display: none; flex-direction: column; flex: 1; min-height: 0; }
.chat-active.visible { display: flex; }
.chat-with {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 0.95rem;
    background: var(--bg-soft);
}
.chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    -webkit-overflow-scrolling: touch;
}
.chat-messages .msg {
    max-width: 85%;
    padding: 0.6rem 0.9rem;
    border-radius: 16px;
    line-height: 1.5;
    word-break: break-word;
}
.chat-messages .msg.sent {
    align-self: flex-end;
    background: var(--accent);
    color: #fff;
    border-bottom-left-radius: 4px;
}
.chat-messages .msg.received {
    align-self: flex-start;
    background: var(--border);
    border-bottom-right-radius: 4px;
}
.chat-messages .msg time {
    font-size: 0.7rem;
    opacity: 0.85;
    display: block;
    margin-top: 0.35rem;
}
.chat-messages .msg .msg-img {
    max-width: 100%;
    border-radius: 8px;
    display: block;
    margin-bottom: 0.25rem;
}
.chat-messages .msg .msg-file {
    color: inherit;
    text-decoration: underline;
}
.chat-form {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
    padding: 1rem;
    padding-left: max(1rem, var(--safe-top));
    padding-right: max(1rem, var(--safe-bottom));
    padding-bottom: max(1rem, var(--safe-bottom));
    border-top: 1px solid var(--border);
    background: var(--surface);
}
.chat-form .form-row { flex: 1; display: flex; gap: 0.5rem; min-width: 0; }
.chat-form input[type="text"] { flex: 1; min-width: 0; margin: 0; }
.chat-form .btn-attach { flex-shrink: 0; padding: 0.65rem 0.9rem; }
.chat-form .file-name { font-size: 0.8rem; color: var(--text-soft); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.loading { opacity: 0.7; pointer-events: none; }
.toast {
    position: fixed;
    bottom: max(1.5rem, calc(var(--safe-bottom) + 1rem));
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--danger);
    color: #fff;
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    z-index: 100;
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
}
.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
{% endblock %}
{% block body %}
<div class="messenger-page container">
    <header class="msg-header">
        <button type="button" class="btn btn-ghost back-btn" id="backBtn" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª">â†</button>
        <span class="title" id="headerTitle">Ù…Ø³Ù†Ø¬Ø± â€” {{ username }}</span>
        <a href="{{ url_for('user_change_password') }}" class="btn btn-ghost header-link" title="ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</a>
    </header>
    <div class="open-chat-bar">
        <label for="otherUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</label>
        <input type="text" id="otherUsername" placeholder="Ù…Ø«Ø§Ù„: ali" autocomplete="off" dir="ltr" style="text-align: left;">
        <button type="button" class="btn" id="btnOpenChat">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª</button>
        <span class="open-error" id="openError"></span>
    </div>
    <div class="chat-body">
        <div class="chat-placeholder" id="chatPlaceholder">
            <div class="history-section">
                <div class="history-title">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</div>
                <div class="history-search">
                    <input type="text" id="convoSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú¯ÙØªÚ¯ÙˆÙ‡Ø§..." autocomplete="off">
                    <button type="button" class="btn btn-secondary" id="convoSearchBtn">Ø¬Ø³ØªØ¬Ùˆ</button>
                </div>
                <ul class="history-list" id="historyList"></ul>
                <div class="history-empty" id="historyEmpty" style="display: none;">
                    Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù Ø±Ø§ Ù¾Ø§ÛŒÛŒÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.
                </div>
            </div>
        </div>
        <div class="chat-active" id="chatActive">
            <div class="chat-with" id="chatHeader">
                <span id="chatHeaderTitle"></span>
                <button type="button" class="btn btn-ghost btn-sm" id="blockBtn" style="display: none;">Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <form class="chat-form" id="chatForm">
                <div class="form-row">
                    <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… ÛŒØ§ ØªÙˆØ¶ÛŒØ­ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„..." autocomplete="off" maxlength="4096">
                    <button type="button" class="btn btn-secondary btn-attach" id="btnAttach" title="Ø¹Ú©Ø³ ÛŒØ§ ÙØ§ÛŒÙ„">ğŸ“</button>
                </div>
                <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar,.mp3,.mp4,.webm,.ogg,.wav,.m4a" style="display: none;">
                <button type="submit" class="btn">Ø§Ø±Ø³Ø§Ù„</button>
            </form>
            <div class="file-name" id="filePreview"></div>
        </div>
    </div>
</div>
<div class="toast" id="toast" role="alert"></div>
{% endblock %}
{% block extra_js %}
<script>
const userId = {{ user_id | default(0) }};
const username = {{ username | tojson }};
const csrfToken = {{ csrf_token | tojson }};

const backBtn = document.getElementById('backBtn');
const headerTitle = document.getElementById('headerTitle');
const otherUsernameInput = document.getElementById('otherUsername');
const btnOpenChat = document.getElementById('btnOpenChat');
const openError = document.getElementById('openError');
const chatPlaceholder = document.getElementById('chatPlaceholder');
const chatActive = document.getElementById('chatActive');
const chatHeader = document.getElementById('chatHeader');
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const msgInput = document.getElementById('msgInput');
const btnAttach = document.getElementById('btnAttach');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const toastEl = document.getElementById('toast');
const historyList = document.getElementById('historyList');
const historyEmpty = document.getElementById('historyEmpty');
const convoSearch = document.getElementById('convoSearch');
const convoSearchBtn = document.getElementById('convoSearchBtn');
const chatHeaderTitle = document.getElementById('chatHeaderTitle');
const blockBtn = document.getElementById('blockBtn');

let currentOtherId = null;
let currentOtherName = null;
let selectedFile = null;
let iBlockedThem = false;
var chatPollInterval = null;

function stopChatPoll() {
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
}

function startChatPoll() {
    if (chatPollInterval) return;
    chatPollInterval = setInterval(function() {
        if (currentOtherId) loadChat(true);
    }, 3500);
}

function showOpenError(msg) {
    openError.textContent = msg || '';
}

function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(function() { toastEl.classList.remove('show'); }, 3000);
}

function setLoading(loading) {
    btnOpenChat.disabled = loading;
    if (loading) btnOpenChat.classList.add('loading');
    else btnOpenChat.classList.remove('loading');
}

function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

btnAttach.addEventListener('click', function() { fileInput.click(); });
fileInput.addEventListener('change', function() {
    selectedFile = this.files[0] || null;
    filePreview.textContent = selectedFile ? selectedFile.name : '';
});

function loadConversations(q) {
    var url = '/api/conversations';
    if (q) url += '?q=' + encodeURIComponent(q);
    fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(list) {
            if (!Array.isArray(list) || list.length === 0) {
                historyList.innerHTML = '';
                historyEmpty.style.display = 'block';
                historyEmpty.textContent = q ? 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.' : 'Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù Ø±Ø§ Ù¾Ø§ÛŒÛŒÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.';
                return;
            }
            historyEmpty.style.display = 'none';
            historyList.innerHTML = list.map(function(c) {
                var rawName = (c.other_username != null) ? String(c.other_username) : '';
                var safeName = escapeHtml(rawName);
                var safePreview = escapeHtml(c.last_preview || '');
                var safeTime = escapeHtml(c.last_at || '');
                return '<li class="history-item" data-id="' + c.other_id + '" data-name="' + safeName + '">' +
                    '<div class="h-username">' + safeName + '</div>' +
                    '<div class="h-preview">' + safePreview + '</div>' +
                    '<div class="h-time">' + safeTime + '</div></li>';
            }).join('');
            historyList.querySelectorAll('.history-item').forEach(function(el) {
                el.addEventListener('click', function() {
                    var id = parseInt(el.getAttribute('data-id'), 10);
                    if (id !== id) return;
                    var name = el.getAttribute('data-name') || '';
                    currentOtherId = id;
                    currentOtherName = name;
                    chatPlaceholder.style.display = 'none';
                    chatActive.classList.add('visible');
                    if (chatHeaderTitle) chatHeaderTitle.textContent = 'Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ ' + name;
                    backBtn.classList.add('visible');
                    headerTitle.textContent = name;
                    loadChat();
                });
            });
        })
        .catch(function() {
            historyList.innerHTML = '';
            historyEmpty.style.display = 'block';
            historyEmpty.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
        });
}

if (convoSearchBtn && convoSearch) {
    convoSearchBtn.addEventListener('click', function() { loadConversations(convoSearch.value.trim()); });
    convoSearch.addEventListener('keydown', function(e) { if (e.key === 'Enter') loadConversations(convoSearch.value.trim()); });
}

backBtn.addEventListener('click', function() {
    stopChatPoll();
    chatActive.classList.remove('visible');
    chatPlaceholder.style.display = 'flex';
    headerTitle.textContent = 'Ù…Ø³Ù†Ø¬Ø± â€” ' + username;
    backBtn.classList.remove('visible');
    currentOtherId = null;
    currentOtherName = null;
    selectedFile = null;
    filePreview.textContent = '';
    fileInput.value = '';
    showOpenError('');
    loadConversations();
});

btnOpenChat.addEventListener('click', async function() {
    const raw = otherUsernameInput.value.trim();
    showOpenError('');
    if (!raw) {
        showOpenError('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        return;
    }
    setLoading(true);
    try {
        const r = await fetch('/api/user-by-username/' + encodeURIComponent(raw));
        const data = await r.json();
        if (r.status === 404 || r.status === 400 || data.error) {
            showOpenError(data.error || 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
            return;
        }
        currentOtherId = data.id;
        currentOtherName = data.username;
        chatPlaceholder.style.display = 'none';
        chatActive.classList.add('visible');
        if (chatHeaderTitle) chatHeaderTitle.textContent = 'Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ ' + currentOtherName;
        backBtn.classList.add('visible');
        headerTitle.textContent = currentOtherName;
        loadChat();
        loadConversations();
    } finally {
        setLoading(false);
    }
});

function buildMessageHtml(m, otherReadUpTo) {
    var sent = m.sender_id === userId;
    var cls = sent ? 'sent' : 'received';
    var parts = [];
    if (sent && m.id) {
        parts.push('<button type="button" class="msg-del btn btn-ghost" data-msg-id="' + m.id + '" title="Ø­Ø°Ù Ù¾ÛŒØ§Ù…">Ã—</button>');
    }
    if (m.message_type === 'image' && m.id) {
        parts.push('<img class="msg-img" src="/api/file/' + m.id + '" alt="Ø¹Ú©Ø³" loading="lazy">');
    }
    if (m.message_type === 'file' && m.id && m.file_name) {
        parts.push('<a class="msg-file" href="/api/file/' + m.id + '" download="' + escapeHtml(m.file_name) + '">' + escapeHtml(m.file_name) + '</a>');
    }
    if (m.body) {
        parts.push(escapeHtml(m.body));
    }
    if (parts.length === 0) {
        parts.push('[Ù¾ÛŒØ§Ù…]');
    }
    parts.push('<time>' + escapeHtml(m.created_at) + '</time>');
    if (sent && otherReadUpTo != null && m.id <= otherReadUpTo) {
        parts.push('<span class="msg-read">âœ“âœ“</span>');
    }
    return '<div class="msg ' + cls + '" data-msg-id="' + (m.id || '') + '">' + parts.join('') + '</div>';
}

function loadChat(isPolling) {
    if (!currentOtherId) return;
    var wasAtBottom = !isPolling || (chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 80);
    fetch('/api/chat/' + currentOtherId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                if (!isPolling) chatMessages.innerHTML = '<p class="error">' + escapeHtml(data.error) + '</p>';
                return;
            }
            iBlockedThem = data.i_blocked_them || false;
            if (blockBtn) {
                blockBtn.style.display = 'inline-flex';
                blockBtn.textContent = iBlockedThem ? 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª' : 'Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†';
            }
            var otherReadUpTo = data.other_read_up_to != null ? data.other_read_up_to : null;
            chatMessages.innerHTML = data.messages.map(function(m) { return buildMessageHtml(m, otherReadUpTo); }).join('');
            chatMessages.querySelectorAll('.msg-del').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var mid = parseInt(btn.getAttribute('data-msg-id'), 10);
                    if (mid !== mid) return;
                    fetch('/api/message/' + mid, {
                        method: 'DELETE',
                        headers: { 'X-CSRF-Token': csrfToken }
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        if (res.ok) {
                            var el = chatMessages.querySelector('.msg[data-msg-id="' + mid + '"]');
                            if (el) el.remove();
                        } else { showToast(res.error || 'Ø®Ø·Ø§'); }
                    });
                });
            });
            if (wasAtBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
            var maxId = 0;
            data.messages.forEach(function(m) { if (m.id > maxId) maxId = m.id; });
            if (maxId > 0) {
                fetch('/api/chat/' + currentOtherId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ read_receipt: true, last_read_message_id: maxId })
                });
            }
            if (!isPolling) startChatPoll();
        });
}

if (blockBtn) {
    blockBtn.addEventListener('click', function() {
        if (!currentOtherId) return;
        var method = iBlockedThem ? 'DELETE' : 'POST';
        fetch('/api/block/' + currentOtherId, {
            method: method,
            headers: { 'X-CSRF-Token': csrfToken }
        }).then(function(r) { return r.json(); }).then(function(res) {
            if (res.ok) {
                iBlockedThem = !iBlockedThem;
                blockBtn.textContent = iBlockedThem ? 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª' : 'Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†';
                showToast(iBlockedThem ? 'Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.' : 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ø´Ø¯.');
            } else { showToast(res.error || 'Ø®Ø·Ø§'); }
        });
    });
}

loadConversations();

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentOtherId) return;
    var body = msgInput.value.trim();
    var btn = chatForm.querySelector('button[type="submit"]');

    if (selectedFile) {
        btn.disabled = true;
        var fd = new FormData();
        fd.append('file', selectedFile);
        fd.append('receiver_id', currentOtherId);
        fd.append('body', body);
        fd.append('csrf_token', csrfToken);
        try {
            var r = await fetch('/api/send', { method: 'POST', body: fd });
            var res = await r.json();
            if (res.ok) {
                msgInput.value = '';
                selectedFile = null;
                fileInput.value = '';
                filePreview.textContent = '';
                loadChat();
            } else {
                showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„');
            }
        } finally {
            btn.disabled = false;
        }
        return;
    }

    if (!body) return;
    btn.disabled = true;
    try {
        var r = await fetch('/api/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ receiver_id: currentOtherId, body: body })
        });
        var res = await r.json();
        if (res.ok) {
            msgInput.value = '';
            loadChat();
        } else {
            showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„');
        }
    } finally {
        btn.disabled = false;
    }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Ù…Ø³Ù†Ø¬Ø± â€” {{ username }}{% endblock %}
{% block extra_css %}
.messenger-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - var(--safe-top) - var(--safe-bottom));
    height: calc(100dvh - var(--safe-top) - var(--safe-bottom));
    max-height: 860px;
    margin: 0 auto;
    max-width: 680px;
    background: rgba(30, 41, 59, 0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 24px;
    overflow: hidden;
    border: 1px solid rgba(71, 85, 105, 0.4);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.45);
    transition: box-shadow var(--transition);
}
.messenger-page:focus-within { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 0 1px var(--accent-dim); }
.msg-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.85rem 1.25rem;
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(30, 41, 59, 0.95) 100%);
    border-bottom: 1px solid rgba(71, 85, 105, 0.4);
    min-height: 60px;
    transition: background var(--transition);
}
.msg-header .back-btn {
    display: none;
    min-width: 44px;
    min-height: 44px;
    padding: 0;
    border-radius: 12px;
    color: var(--text);
    transition: background var(--transition), transform 0.15s var(--ease);
}
.msg-header .back-btn:hover { background: var(--accent-dim); color: var(--accent); }
.msg-header .back-btn.visible { display: inline-flex; }
.msg-header .title { flex: 1; font-weight: 700; font-size: 1.05rem; letter-spacing: -0.02em; }
.msg-header .header-link { font-size: 0.85rem; padding: 0.5rem 0.9rem; text-decoration: none; border-radius: 10px; }
.open-chat-bar {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(71, 85, 105, 0.35);
    display: flex;
    gap: 0.6rem;
    align-items: center;
    flex-wrap: wrap;
    background: rgba(15, 23, 42, 0.3);
}
.open-chat-bar label { margin: 0; font-size: 0.9rem; font-weight: 600; color: var(--text-soft); }
.open-chat-bar input[type="text"] {
    width: 160px;
    max-width: 200px;
    margin: 0;
    border-radius: var(--radius-pill);
    padding: 0.5rem 1rem;
}
.open-chat-bar .open-error { color: var(--danger); width: 100%; font-size: 0.85rem; margin-top: 0.35rem; }
.chat-body { flex: 1; display: flex; flex-direction: column; min-height: 0; }
.chat-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    animation: fadeIn 0.3s var(--ease);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.chat-placeholder .history-section {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.25rem;
    -webkit-overflow-scrolling: touch;
}
.chat-placeholder .history-title {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--text-soft);
    margin-bottom: 0.75rem;
    padding: 0.25rem 0;
}
.chat-placeholder .history-search {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}
.chat-placeholder .history-search input {
    flex: 1;
    max-width: 220px;
    margin: 0;
    border-radius: var(--radius-pill);
    padding: 0.55rem 1rem;
}
.chat-placeholder .history-list { list-style: none; margin: 0; padding: 0; }
.chat-placeholder .history-item {
    display: block;
    padding: 1rem 1.25rem;
    border-radius: 16px;
    margin-bottom: 0.5rem;
    background: rgba(51, 65, 85, 0.4);
    border: 1px solid transparent;
    cursor: pointer;
    text-align: right;
    transition: all var(--transition);
    animation: fadeIn 0.35s var(--ease) backwards;
}
.chat-placeholder .history-item:hover {
    background: rgba(6, 182, 212, 0.12);
    border-color: rgba(6, 182, 212, 0.3);
    transform: translateX(-2px);
}
.chat-placeholder .history-item:active { transform: scale(0.99); }
.chat-placeholder .history-item .h-username { font-weight: 700; margin-bottom: 0.25rem; font-size: 1rem; }
.chat-placeholder .history-item .h-preview { font-size: 0.85rem; color: var(--text-soft); line-height: 1.4; }
.chat-placeholder .history-item .h-time { font-size: 0.75rem; color: var(--text-soft); margin-top: 0.35rem; opacity: 0.9; }
.chat-placeholder .history-empty {
    color: var(--text-soft);
    padding: 2.5rem 1rem;
    text-align: center;
    line-height: 1.8;
    font-size: 0.95rem;
}
.chat-active {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    animation: fadeIn 0.35s var(--ease);
}
.chat-active.visible { display: flex; }
.chat-with {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid rgba(71, 85, 105, 0.35);
    font-weight: 700;
    font-size: 1rem;
    background: rgba(15, 23, 42, 0.4);
}
.chat-with .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8rem; border-radius: 10px; }
.chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    -webkit-overflow-scrolling: touch;
    background: repeating-linear-gradient(
        180deg,
        transparent,
        transparent 40px,
        rgba(0,0,0,0.02) 40px,
        rgba(0,0,0,0.02) 41px
    );
}
.chat-messages .msg {
    max-width: 82%;
    padding: 0.75rem 1rem;
    border-radius: 18px;
    line-height: 1.55;
    word-break: break-word;
    box-shadow: var(--shadow-sm);
    transition: transform 0.15s var(--ease);
    animation: msgIn 0.25s var(--ease);
}
@keyframes msgIn {
    from { opacity: 0; transform: scale(0.96); }
    to { opacity: 1; transform: scale(1); }
}
.chat-messages .msg.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--accent), #0891b2);
    color: #fff;
    border-bottom-left-radius: 6px;
}
.chat-messages .msg.received {
    align-self: flex-start;
    background: var(--surface);
    border: 1px solid rgba(71, 85, 105, 0.5);
    border-bottom-right-radius: 6px;
}
.chat-messages .msg time {
    font-size: 0.7rem;
    opacity: 0.9;
    display: block;
    margin-top: 0.4rem;
}
.chat-messages .msg .msg-img {
    max-width: 100%;
    border-radius: 12px;
    display: block;
    margin-bottom: 0.35rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.chat-messages .msg .msg-file { color: inherit; text-decoration: underline; opacity: 0.95; }
.msg { position: relative; }
.msg .msg-del {
    position: absolute;
    left: 0.35rem;
    top: 0.35rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    border-radius: 8px;
    opacity: 0.85;
    transition: opacity var(--transition), background var(--transition);
}
.msg .msg-del:hover { opacity: 1; background: rgba(0,0,0,0.2); }
.msg .msg-read { font-size: 0.7rem; margin-top: 0.2rem; opacity: 0.9; }
.chat-form {
    display: flex;
    gap: 0.6rem;
    align-items: flex-end;
    padding: 1rem 1.25rem;
    padding-bottom: max(1rem, var(--safe-bottom));
    border-top: 1px solid rgba(71, 85, 105, 0.35);
    background: rgba(15, 23, 42, 0.5);
}
.chat-form .form-row { flex: 1; display: flex; gap: 0.5rem; min-width: 0; }
.chat-form input[type="text"] {
    flex: 1;
    min-width: 0;
    margin: 0;
    border-radius: var(--radius-pill);
    padding: 0.75rem 1.25rem;
}
.chat-form .btn-attach {
    flex-shrink: 0;
    padding: 0.75rem 1rem;
    border-radius: 14px;
    transition: background var(--transition), transform 0.15s var(--ease);
}
.chat-form .btn-attach:hover { transform: scale(1.05); }
.chat-form .btn-voice {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    transition: background var(--transition), transform 0.2s var(--ease), box-shadow 0.2s var(--ease);
    font-size: 1.25rem;
}
.chat-form .btn-voice:hover { transform: scale(1.08); }
.chat-form .btn-voice.recording {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: #fff;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.35);
    animation: btnVoicePulse 1.5s ease-in-out infinite;
}
@keyframes btnVoicePulse {
    0%, 100% { box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.35); }
    50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0.15); }
}

/* â€”â€”â€” Ú©Ø§Ø±Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† â€”â€”â€” */
.mic-permission-card {
    margin: 0 1.25rem 1rem;
    padding: 1.1rem 1.25rem;
    border-radius: 18px;
    background: linear-gradient(145deg, rgba(6, 182, 212, 0.12) 0%, rgba(15, 23, 42, 0.85) 100%);
    border: 1px solid rgba(6, 182, 212, 0.25);
    display: flex;
    align-items: center;
    gap: 1rem;
    animation: fadeIn 0.4s var(--ease);
}
.mic-permission-card.insecure {
    background: linear-gradient(145deg, rgba(251, 191, 36, 0.1) 0%, rgba(15, 23, 42, 0.85) 100%);
    border-color: rgba(251, 191, 36, 0.3);
}
.mic-permission-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(6, 182, 212, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}
.mic-permission-card.insecure .mic-permission-icon { background: rgba(251, 191, 36, 0.2); }
.mic-permission-text { flex: 1; min-width: 0; }
.mic-permission-text strong { display: block; margin-bottom: 0.2rem; font-size: 0.95rem; }
.mic-permission-text span { font-size: 0.85rem; color: var(--text-soft); line-height: 1.45; }
.mic-permission-card .btn { flex-shrink: 0; white-space: nowrap; }

/* â€”â€”â€” Ù†ÙˆØ§Ø± Ø¶Ø¨Ø· (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€” */
.voice-recording {
    display: none;
    align-items: center;
    gap: 1rem;
    padding: 0.85rem 1.25rem;
    margin: 0 1.25rem 0.75rem;
    border-radius: 20px;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
    border: 1px solid rgba(239, 68, 68, 0.25);
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    animation: fadeIn 0.25s var(--ease);
}
.voice-recording .voice-recording-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ef4444;
    flex-shrink: 0;
    animation: voicePulse 1s ease-in-out infinite;
}
@keyframes voicePulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.1); } }
.voice-recording .voice-recording-time {
    font-variant-numeric: tabular-nums;
    font-weight: 700;
    font-size: 1rem;
    min-width: 2.8em;
}
.voice-recording .voice-recording-label {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-soft);
}
.voice-recording-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.voice-recording-actions .btn-icon {
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    transition: transform 0.15s var(--ease), background 0.2s var(--ease);
}
.voice-recording-actions .btn-icon:hover { transform: scale(1.08); }
.voice-recording-actions .btn-icon-cancel {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}
.voice-recording-actions .btn-icon-send {
    background: var(--accent);
    color: #fff;
}

/* â€”â€”â€” Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙˆÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ â€”â€”â€” */
.voice-preview {
    display: none;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    margin: 0 1.25rem 0.75rem;
    border-radius: 20px;
    background: linear-gradient(135deg, rgba(51, 65, 85, 0.5) 0%, rgba(30, 41, 59, 0.7) 100%);
    border: 1px solid rgba(71, 85, 105, 0.5);
    animation: fadeIn 0.3s var(--ease);
}
.voice-preview .voice-preview-player {
    display: flex;
    align-items: center;
    gap: 0.85rem;
}
.voice-preview .voice-preview-play-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--accent);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
    transition: transform 0.15s var(--ease), box-shadow 0.2s var(--ease);
}
.voice-preview .voice-preview-play-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px var(--accent-glow);
}
.voice-preview .voice-preview-play-btn.playing { background: var(--surface-hover); }
.voice-preview-progress-wrap {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: rgba(71, 85, 105, 0.5);
    overflow: hidden;
}
.voice-preview-progress {
    height: 100%;
    width: 0%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 0.1s linear;
}
.voice-preview-duration {
    font-variant-numeric: tabular-nums;
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 2.5em;
    color: var(--text-soft);
}
.voice-preview-actions {
    display: flex;
    gap: 0.6rem;
    justify-content: flex-end;
}
.voice-preview-actions .btn { min-height: 40px; }

/* â€”â€”â€” Ø­Ø¨Ø§Ø¨ ÙˆÛŒØ³ Ø¯Ø± Ú†Øª (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€” */
.voice-msg-bubble {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.9rem 0.6rem 0.6rem;
    min-width: 0;
    max-width: 280px;
}
.voice-msg-bubble .voice-play-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: inherit;
    font-size: 1rem;
    flex-shrink: 0;
    transition: background 0.2s var(--ease), transform 0.15s var(--ease);
}
.voice-msg-bubble .voice-play-btn:hover { background: rgba(255,255,255,0.35); transform: scale(1.05); }
.voice-msg-bubble .voice-waveform {
    flex: 1;
    height: 32px;
    display: flex;
    align-items: center;
    gap: 3px;
    min-width: 0;
}
.voice-msg-bubble .voice-waveform span {
    width: 4px;
    min-width: 4px;
    border-radius: 2px;
    background: currentColor;
    opacity: 0.7;
    height: 50%;
    align-self: center;
    transition: height 0.15s var(--ease);
}
.voice-msg-bubble .voice-waveform span.active { height: 100%; opacity: 1; }
.voice-msg-bubble .voice-duration {
    font-variant-numeric: tabular-nums;
    font-size: 0.8rem;
    opacity: 0.9;
    flex-shrink: 0;
}
.msg.sent .voice-msg-bubble .voice-play-btn { background: rgba(255,255,255,0.3); }
.msg.received .voice-msg-bubble .voice-play-btn { background: rgba(0,0,0,0.15); }
.msg-voice {
    display: none;
}
.chat-form.voice-mode .form-row,
.chat-form.voice-mode button[type="submit"] {
    display: none !important;
}
.chat-form .file-name {
    font-size: 0.8rem;
    color: var(--text-soft);
    max-width: 140px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 0.25rem 0;
}
.loading { opacity: 0.7; pointer-events: none; }
.toast {
    position: fixed;
    bottom: max(1.5rem, calc(var(--safe-bottom) + 1rem));
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--danger), #e11d48);
    color: #fff;
    padding: 0.9rem 1.5rem;
    border-radius: 14px;
    font-size: 0.95rem;
    font-weight: 500;
    z-index: 100;
    opacity: 0;
    box-shadow: 0 10px 40px rgba(244, 63, 94, 0.4);
    transition: transform 0.35s var(--ease), opacity 0.35s var(--ease);
}
.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
@media (max-width: 500px) {
    .messenger-page { border-radius: 0; max-height: none; }
    .chat-messages .msg { max-width: 90%; }
}
{% endblock %}
{% block body %}
<div class="messenger-page container">
    <header class="msg-header">
        <button type="button" class="btn btn-ghost back-btn" id="backBtn" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª">â†</button>
        <span class="title" id="headerTitle">Ù…Ø³Ù†Ø¬Ø± â€” {{ username }}</span>
        <button type="button" class="btn btn-ghost header-link" id="btnNotify" title="Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§">ğŸ””</button>
        <a href="{{ url_for('user_change_password') }}" class="btn btn-ghost header-link" title="ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</a>
        <a href="{{ url_for('logout') }}" class="btn btn-ghost header-link" title="Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨">Ø®Ø±ÙˆØ¬</a>
    </header>
    <div class="open-chat-bar">
        <label for="otherUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</label>
        <input type="text" id="otherUsername" placeholder="Ù…Ø«Ø§Ù„: ali" autocomplete="off" dir="ltr" style="text-align: left;">
        <button type="button" class="btn" id="btnOpenChat">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª</button>
        <span class="open-error" id="openError"></span>
    </div>
    <div class="chat-body">
        <div class="chat-placeholder" id="chatPlaceholder">
            <div class="history-section">
                <div class="history-title">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</div>
                <div class="history-search">
                    <input type="text" id="convoSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú¯ÙØªÚ¯ÙˆÙ‡Ø§..." autocomplete="off">
                    <button type="button" class="btn btn-secondary" id="convoSearchBtn">Ø¬Ø³ØªØ¬Ùˆ</button>
                </div>
                <ul class="history-list" id="historyList"></ul>
                <div class="history-empty" id="historyEmpty" style="display: none;">
                    Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù Ø±Ø§ Ù¾Ø§ÛŒÛŒÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.
                </div>
            </div>
        </div>
        <div class="chat-active" id="chatActive">
            <div class="chat-with" id="chatHeader">
                <span id="chatHeaderTitle"></span>
                <button type="button" class="btn btn-ghost btn-sm" id="blockBtn" style="display: none;">Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <!-- Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† (ÛŒÚ©â€ŒØ¨Ø§Ø± Ù†Ù…Ø§ÛŒØ´) -->
            <div class="mic-permission-card" id="micPermissionCard" style="display: none;">
                <div class="mic-permission-icon" aria-hidden="true">ğŸ¤</div>
                <div class="mic-permission-text">
                    <strong>Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ</strong>
                    <span id="micPermissionDesc">Ø§Ø¬Ø§Ø²Ù‡Ù” Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ³ Ø¶Ø¨Ø· Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</span>
                </div>
                <button type="button" class="btn" id="btnGrantMic">Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†</button>
            </div>
            <form class="chat-form" id="chatForm">
                <div class="form-row">
                    <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… ÛŒØ§ ØªÙˆØ¶ÛŒØ­ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„..." autocomplete="off" maxlength="4096">
                    <button type="button" class="btn btn-secondary btn-attach" id="btnAttach" title="Ø¹Ú©Ø³ ÛŒØ§ ÙØ§ÛŒÙ„">ğŸ“</button>
                    <button type="button" class="btn btn-secondary btn-voice" id="btnVoice" title="Ø¶Ø¨Ø· ÙˆÛŒØ³" aria-label="Ø¶Ø¨Ø· ÙˆÛŒØ³">ğŸ¤</button>
                </div>
                <div class="voice-recording" id="voiceRecording">
                    <span class="voice-recording-dot" aria-hidden="true"></span>
                    <span class="voice-recording-time" id="voiceRecordingTime">0:00</span>
                    <span class="voice-recording-label">Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·...</span>
                    <div class="voice-recording-actions">
                        <button type="button" class="btn-icon btn-icon-cancel" id="btnCancelRecording" title="Ù„ØºÙˆ">ğŸ—‘</button>
                        <button type="button" class="btn-icon btn-icon-send" id="btnStopVoice" title="Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³">âœ“</button>
                    </div>
                </div>
                <div class="voice-preview" id="voicePreview">
                    <div class="voice-preview-player">
                        <button type="button" class="voice-preview-play-btn" id="voicePreviewPlayBtn" title="Ù¾Ø®Ø´" aria-label="Ù¾Ø®Ø´">â–¶</button>
                        <div class="voice-preview-progress-wrap">
                            <div class="voice-preview-progress" id="voicePreviewProgress"></div>
                        </div>
                        <span class="voice-preview-duration" id="voicePreviewDuration">0:00</span>
                    </div>
                    <div class="voice-preview-actions">
                        <button type="button" class="btn btn-ghost btn-sm" id="btnCancelVoice">Ø­Ø°Ù</button>
                        <button type="button" class="btn btn-sm" id="btnSendVoice">Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³</button>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar,.mp3,.mp4,.webm,.ogg,.wav,.m4a" style="display: none;">
                <button type="submit" class="btn">Ø§Ø±Ø³Ø§Ù„</button>
            </form>
            <audio id="voicePreviewAudio" preload="metadata" style="display: none;"></audio>
            <div class="file-name" id="filePreview"></div>
        </div>
    </div>
</div>
<div class="toast" id="toast" role="alert"></div>
{% endblock %}
{% block extra_js %}
<script>
const userId = {{ user_id | default(0) }};
const username = {{ username | tojson }};
const csrfToken = {{ csrf_token | tojson }};

const backBtn = document.getElementById('backBtn');
const headerTitle = document.getElementById('headerTitle');
const otherUsernameInput = document.getElementById('otherUsername');
const btnOpenChat = document.getElementById('btnOpenChat');
const openError = document.getElementById('openError');
const chatPlaceholder = document.getElementById('chatPlaceholder');
const chatActive = document.getElementById('chatActive');
const chatHeader = document.getElementById('chatHeader');
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const msgInput = document.getElementById('msgInput');
const btnAttach = document.getElementById('btnAttach');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const btnVoice = document.getElementById('btnVoice');
const voicePreview = document.getElementById('voicePreview');
const voicePreviewAudio = document.getElementById('voicePreviewAudio');
const voicePreviewPlayBtn = document.getElementById('voicePreviewPlayBtn');
const voicePreviewProgress = document.getElementById('voicePreviewProgress');
const voicePreviewDuration = document.getElementById('voicePreviewDuration');
const btnSendVoice = document.getElementById('btnSendVoice');
const btnCancelVoice = document.getElementById('btnCancelVoice');
const voiceRecording = document.getElementById('voiceRecording');
const voiceRecordingTime = document.getElementById('voiceRecordingTime');
const btnStopVoice = document.getElementById('btnStopVoice');
const btnCancelRecording = document.getElementById('btnCancelRecording');
const micPermissionCard = document.getElementById('micPermissionCard');
const micPermissionDesc = document.getElementById('micPermissionDesc');
const btnGrantMic = document.getElementById('btnGrantMic');
const toastEl = document.getElementById('toast');
const historyList = document.getElementById('historyList');
const historyEmpty = document.getElementById('historyEmpty');
const convoSearch = document.getElementById('convoSearch');
const convoSearchBtn = document.getElementById('convoSearchBtn');
const chatHeaderTitle = document.getElementById('chatHeaderTitle');
const blockBtn = document.getElementById('blockBtn');
const btnNotify = document.getElementById('btnNotify');

let currentOtherId = null;
let currentOtherName = null;
let selectedFile = null;
let iBlockedThem = false;
let isVoiceRecording = false;
let voiceBlob = null;
let voiceChunks = [];
let mediaRecorderInstance = null;
let voiceStream = null;
let voiceRecordingTimer = null;
let voiceRecordingCancelled = false;
var chatPollInterval = null;
const MIC_PERMISSION_KEY = 'mic_permission_requested';
var lastChatMessageCount = 0;
var lastChatLastId = 0;

function stopChatPoll() {
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
}

function startChatPoll() {
    if (chatPollInterval) return;
    chatPollInterval = setInterval(function() {
        if (currentOtherId) loadChat(true);
    }, 3500);
}

function showOpenError(msg) {
    openError.textContent = msg || '';
}

function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(function() { toastEl.classList.remove('show'); }, 3000);
}

function setLoading(loading) {
    btnOpenChat.disabled = loading;
    if (loading) btnOpenChat.classList.add('loading');
    else btnOpenChat.classList.remove('loading');
}

function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

btnAttach.addEventListener('click', function() { fileInput.click(); });
fileInput.addEventListener('change', function() {
    selectedFile = this.files[0] || null;
    filePreview.textContent = selectedFile ? selectedFile.name : '';
});

function formatVoiceTime(sec) {
    if (sec === undefined || isNaN(sec)) return '0:00';
    var m = Math.floor(sec / 60);
    var s = Math.floor(sec % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
}
function hideVoicePreview() {
    if (voiceRecordingTimer) {
        clearInterval(voiceRecordingTimer);
        voiceRecordingTimer = null;
    }
    if (voicePreviewAudio && voicePreviewAudio.src && voicePreviewAudio.src.indexOf('blob:') === 0) {
        URL.revokeObjectURL(voicePreviewAudio.src);
    }
    voicePreviewAudio.removeEventListener('timeupdate', _voicePreviewTimeUpdate);
    voicePreviewAudio.removeEventListener('ended', _voicePreviewEnded);
    voiceBlob = null;
    if (voicePreview) voicePreview.style.display = 'none';
    if (voicePreviewAudio) { voicePreviewAudio.pause(); voicePreviewAudio.src = ''; voicePreviewAudio.srcObject = null; }
    if (voicePreviewPlayBtn) { voicePreviewPlayBtn.textContent = 'â–¶'; voicePreviewPlayBtn.classList.remove('playing'); }
    if (btnVoice) btnVoice.classList.remove('recording');
    if (chatForm) chatForm.classList.remove('voice-mode');
}
function _voicePreviewTimeUpdate() {
    var a = voicePreviewAudio;
    if (voicePreviewProgress && a.duration) voicePreviewProgress.style.width = (100 * a.currentTime / a.duration) + '%';
}
function _voicePreviewEnded() {
    if (voicePreviewPlayBtn) { voicePreviewPlayBtn.textContent = 'â–¶'; voicePreviewPlayBtn.classList.remove('playing'); }
    if (voicePreviewProgress) voicePreviewProgress.style.width = '0%';
}
function showVoicePreview(blob) {
    voiceBlob = blob;
    if (voiceRecording) voiceRecording.style.display = 'none';
    isVoiceRecording = false;
    if (btnVoice) btnVoice.classList.remove('recording');
    if (voiceRecordingTimer) { clearInterval(voiceRecordingTimer); voiceRecordingTimer = null; }
    if (voicePreviewAudio && blob) {
        voicePreviewAudio.src = URL.createObjectURL(blob);
        voicePreviewProgress.style.width = '0%';
        voicePreviewDuration.textContent = '0:00';
        voicePreviewPlayBtn.textContent = 'â–¶';
        voicePreviewPlayBtn.classList.remove('playing');
        voicePreviewAudio.addEventListener('loadedmetadata', function onMeta() {
            voicePreviewDuration.textContent = formatVoiceTime(voicePreviewAudio.duration);
        }, { once: true });
        voicePreviewAudio.addEventListener('timeupdate', _voicePreviewTimeUpdate);
        voicePreviewAudio.addEventListener('ended', _voicePreviewEnded);
        voicePreview.style.display = 'flex';
        if (chatForm) chatForm.classList.add('voice-mode');
    }
}
function startVoiceRecording() {
    if (!window.isSecureContext) {
        showToast('Ø¶Ø¨Ø· ÙˆÛŒØ³ ÙÙ‚Ø· Ø¨Ø§ https ÛŒØ§ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ Ù…Ù…Ú©Ù† Ø§Ø³Øª. Ø³Ø§ÛŒØª Ø±Ø§ Ø¨Ø§ https Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Â«Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡Ù” Ø§ØµÙ„ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
        return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
        return;
    }
    if (!currentOtherId) {
        showToast('Ø§ÙˆÙ„ ÛŒÚ© Ú†Øª Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯');
        return;
    }
    if (iBlockedThem) {
        showToast('Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª');
        return;
    }
    voiceChunks = [];
    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        voiceStream = stream;
        var mime = 'audio/webm';
        if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime = 'audio/webm;codecs=opus';
        else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) mime = 'audio/ogg;codecs=opus';
        mediaRecorderInstance = new MediaRecorder(stream);
        mediaRecorderInstance.ondataavailable = function(e) { if (e.data && e.data.size > 0) voiceChunks.push(e.data); };
        mediaRecorderInstance.onstop = function() {
            voiceStream.getTracks().forEach(function(t) { t.stop(); });
            voiceStream = null;
            if (voiceRecordingCancelled) {
                voiceRecordingCancelled = false;
                return;
            }
            if (voiceChunks.length) {
                var blob = new Blob(voiceChunks, { type: mime });
                showVoicePreview(blob);
            } else {
                showToast('Ø¶Ø¨Ø· Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
            }
        };
        mediaRecorderInstance.start(200);
        isVoiceRecording = true;
        if (voiceRecording) {
            voiceRecording.style.display = 'flex';
            voiceRecordingTime.textContent = '0:00';
        }
        if (chatForm) chatForm.classList.add('voice-mode');
        if (btnVoice) btnVoice.classList.add('recording');
        var startMs = Date.now();
        voiceRecordingTimer = setInterval(function() {
            var sec = Math.floor((Date.now() - startMs) / 1000);
            if (voiceRecordingTime) voiceRecordingTime.textContent = formatVoiceTime(sec);
        }, 1000);
    }).catch(function(err) {
        if (err && err.name === 'NotAllowedError') {
            showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø§ÛŒØª/Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯.');
        } else {
            showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ø¨Ø§ https ÛŒØ§ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.');
        }
    });
}
function stopVoiceRecording() {
    if (!isVoiceRecording || !mediaRecorderInstance || mediaRecorderInstance.state === 'inactive') return;
    if (voiceRecordingTimer) { clearInterval(voiceRecordingTimer); voiceRecordingTimer = null; }
    mediaRecorderInstance.stop();
    mediaRecorderInstance = null;
}
function cancelVoiceRecording() {
    if (!isVoiceRecording || !mediaRecorderInstance) return;
    voiceRecordingCancelled = true;
    if (voiceRecordingTimer) { clearInterval(voiceRecordingTimer); voiceRecordingTimer = null; }
    mediaRecorderInstance.stop();
    mediaRecorderInstance = null;
    voiceChunks = [];
    isVoiceRecording = false;
    if (voiceRecording) voiceRecording.style.display = 'none';
    if (btnVoice) btnVoice.classList.remove('recording');
    if (chatForm) chatForm.classList.remove('voice-mode');
    showToast('Ø¶Ø¨Ø· Ù„ØºÙˆ Ø´Ø¯');
}

if (btnVoice) {
    btnVoice.addEventListener('click', function() {
        if (voiceBlob) { hideVoicePreview(); return; }
        if (isVoiceRecording) { stopVoiceRecording(); return; }
        startVoiceRecording();
    });
}
if (btnStopVoice) {
    btnStopVoice.addEventListener('click', stopVoiceRecording);
}
if (btnCancelRecording) {
    btnCancelRecording.addEventListener('click', cancelVoiceRecording);
}
if (voicePreviewPlayBtn && voicePreviewAudio) {
    voicePreviewPlayBtn.addEventListener('click', function() {
        if (voicePreviewAudio.paused) {
            voicePreviewAudio.play();
            voicePreviewPlayBtn.textContent = 'âšâš';
            voicePreviewPlayBtn.classList.add('playing');
        } else {
            voicePreviewAudio.pause();
            voicePreviewPlayBtn.textContent = 'â–¶';
            voicePreviewPlayBtn.classList.remove('playing');
        }
    });
}
if (btnSendVoice) {
    btnSendVoice.addEventListener('click', async function() {
        if (!voiceBlob || !currentOtherId) return;
        var fd = new FormData();
        fd.append('file', voiceBlob, 'voice.webm');
        fd.append('receiver_id', currentOtherId);
        fd.append('message_type', 'voice');
        fd.append('csrf_token', csrfToken);
        btnSendVoice.disabled = true;
        try {
            var r = await fetch('/api/send', { method: 'POST', body: fd });
            var res = await r.json();
            if (res.ok) {
                hideVoicePreview();
                loadChat();
                showToast('ÙˆÛŒØ³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            } else {
                showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³');
            }
        } finally {
            btnSendVoice.disabled = false;
        }
    });
}
if (btnCancelVoice) {
    btnCancelVoice.addEventListener('click', hideVoicePreview);
}

function updateMicPermissionCard() {
    if (!micPermissionCard || !chatActive) return;
    var hasRequested = localStorage.getItem(MIC_PERMISSION_KEY) === '1';
    var chatOpen = chatActive.classList.contains('visible') && currentOtherId;
    if (!chatOpen || hasRequested) {
        micPermissionCard.style.display = 'none';
        return;
    }
    if (!window.isSecureContext) {
        micPermissionCard.className = 'mic-permission-card insecure';
        if (micPermissionDesc) micPermissionDesc.textContent = 'Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ÙˆÛŒØ³ØŒ Ø³Ø§ÛŒØª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ https Ø¨Ø§Ø² Ø´ÙˆØ¯ ÛŒØ§ ÙˆØ¨â€ŒØ§Ù¾ Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯.';
        if (btnGrantMic) { btnGrantMic.textContent = 'Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…'; btnGrantMic.dataset.action = 'dismiss'; }
    } else {
        micPermissionCard.className = 'mic-permission-card';
        if (micPermissionDesc) micPermissionDesc.textContent = 'Ø§Ø¬Ø§Ø²Ù‡Ù” Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ³ Ø¶Ø¨Ø· Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.';
        if (btnGrantMic) { btnGrantMic.textContent = 'Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†'; btnGrantMic.dataset.action = 'grant'; }
    }
    micPermissionCard.style.display = 'flex';
}
if (btnGrantMic) {
    btnGrantMic.addEventListener('click', function() {
        if (btnGrantMic.dataset.action === 'dismiss') {
            localStorage.setItem(MIC_PERMISSION_KEY, '1');
            micPermissionCard.style.display = 'none';
            return;
        }
        if (!window.isSecureContext) {
            showToast('Ø¶Ø¨Ø· ÙˆÛŒØ³ ÙÙ‚Ø· Ø¨Ø§ https ÛŒØ§ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ Ù…Ù…Ú©Ù† Ø§Ø³Øª.');
            return;
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showToast('Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
            return;
        }
        navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
            stream.getTracks().forEach(function(t) { t.stop(); });
            localStorage.setItem(MIC_PERMISSION_KEY, '1');
            micPermissionCard.style.display = 'none';
            showToast('Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† ÙØ¹Ø§Ù„ Ø´Ø¯. Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ ÙˆÛŒØ³ Ø¨ÙØ±Ø³ØªÛŒØ¯.');
        }).catch(function(err) {
            if (err && err.name === 'NotAllowedError') {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯.');
            } else {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.');
            }
            localStorage.setItem(MIC_PERMISSION_KEY, '1');
            micPermissionCard.style.display = 'none';
        });
    });
}

function loadConversations(q) {
    var url = '/api/conversations';
    if (q) url += '?q=' + encodeURIComponent(q);
    fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(list) {
            if (!Array.isArray(list) || list.length === 0) {
                historyList.innerHTML = '';
                historyEmpty.style.display = 'block';
                historyEmpty.textContent = q ? 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.' : 'Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù Ø±Ø§ Ù¾Ø§ÛŒÛŒÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.';
                return;
            }
            historyEmpty.style.display = 'none';
            historyList.innerHTML = list.map(function(c, i) {
                var rawName = (c.other_username != null) ? String(c.other_username) : '';
                var safeName = escapeHtml(rawName);
                var safePreview = escapeHtml(c.last_preview || '');
                var safeTime = escapeHtml(c.last_at || '');
                return '<li class="history-item" data-id="' + c.other_id + '" data-name="' + safeName + '" style="animation-delay:' + (i * 0.03) + 's">' +
                    '<div class="h-username">' + safeName + '</div>' +
                    '<div class="h-preview">' + safePreview + '</div>' +
                    '<div class="h-time">' + safeTime + '</div></li>';
            }).join('');
            historyList.querySelectorAll('.history-item').forEach(function(el) {
                el.addEventListener('click', function() {
                    var id = parseInt(el.getAttribute('data-id'), 10);
                    if (id !== id) return;
                    var name = el.getAttribute('data-name') || '';
                    currentOtherId = id;
                    currentOtherName = name;
                    lastChatMessageCount = 0;
                    lastChatLastId = 0;
                    chatPlaceholder.style.display = 'none';
                    chatActive.classList.add('visible');
                    if (chatHeaderTitle) chatHeaderTitle.textContent = 'Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ ' + name;
                    backBtn.classList.add('visible');
                    headerTitle.textContent = name;
                    loadChat();
                    updateMicPermissionCard();
                });
            });
        })
        .catch(function() {
            historyList.innerHTML = '';
            historyEmpty.style.display = 'block';
            historyEmpty.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
        });
}

if (convoSearchBtn && convoSearch) {
    convoSearchBtn.addEventListener('click', function() { loadConversations(convoSearch.value.trim()); });
    convoSearch.addEventListener('keydown', function(e) { if (e.key === 'Enter') loadConversations(convoSearch.value.trim()); });
}

backBtn.addEventListener('click', function() {
    stopChatPoll();
    if (isVoiceRecording) stopVoiceRecording();
    hideVoicePreview();
    chatActive.classList.remove('visible');
    chatPlaceholder.style.display = 'flex';
    headerTitle.textContent = 'Ù…Ø³Ù†Ø¬Ø± â€” ' + username;
    backBtn.classList.remove('visible');
    currentOtherId = null;
    currentOtherName = null;
    lastChatMessageCount = 0;
    lastChatLastId = 0;
    selectedFile = null;
    filePreview.textContent = '';
    fileInput.value = '';
    showOpenError('');
    loadConversations();
});

btnOpenChat.addEventListener('click', async function() {
    const raw = otherUsernameInput.value.trim();
    showOpenError('');
    if (!raw) {
        showOpenError('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        return;
    }
    setLoading(true);
    try {
        const r = await fetch('/api/user-by-username/' + encodeURIComponent(raw));
        const data = await r.json();
        if (r.status === 404 || r.status === 400 || data.error) {
            showOpenError(data.error || 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
            return;
        }
        currentOtherId = data.id;
        currentOtherName = data.username;
        lastChatMessageCount = 0;
        lastChatLastId = 0;
        chatPlaceholder.style.display = 'none';
        chatActive.classList.add('visible');
        if (chatHeaderTitle) chatHeaderTitle.textContent = 'Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ ' + currentOtherName;
        backBtn.classList.add('visible');
        headerTitle.textContent = currentOtherName;
        loadChat();
        loadConversations();
        updateMicPermissionCard();
    } finally {
        setLoading(false);
    }
});

function initVoiceBubbles() {
    if (!chatMessages) return;
    chatMessages.querySelectorAll('.voice-msg-bubble').forEach(function(bubble) {
        var btn = bubble.querySelector('.voice-play-btn');
        var durEl = bubble.querySelector('.voice-duration');
        var audio = bubble.querySelector('audio');
        var waveform = bubble.querySelector('.voice-waveform');
        if (!btn || !audio) return;
        audio.addEventListener('loadedmetadata', function() {
            if (durEl) durEl.textContent = formatVoiceTime(audio.duration);
        });
        audio.addEventListener('ended', function() {
            if (btn) { btn.textContent = 'â–¶'; btn.classList.remove('playing'); }
            if (waveform) waveform.querySelectorAll('span').forEach(function(s) { s.classList.remove('active'); });
        });
        audio.addEventListener('timeupdate', function() {
            if (!waveform || !audio.duration) return;
            var pct = audio.currentTime / audio.duration;
            var idx = Math.floor(pct * 20);
            waveform.querySelectorAll('span').forEach(function(s, i) {
                if (i <= idx) s.classList.add('active'); else s.classList.remove('active');
            });
        });
        btn.addEventListener('click', function() {
            if (audio.paused) {
                audio.play();
                btn.textContent = 'âšâš';
                btn.classList.add('playing');
            } else {
                audio.pause();
                btn.textContent = 'â–¶';
                btn.classList.remove('playing');
            }
        });
    });
}

function buildMessageHtml(m, otherReadUpTo) {
    var sent = m.sender_id === userId;
    var cls = sent ? 'sent' : 'received';
    var parts = [];
    if (sent && m.id) {
        parts.push('<button type="button" class="msg-del btn btn-ghost" data-msg-id="' + m.id + '" title="Ø­Ø°Ù Ù¾ÛŒØ§Ù…">Ã—</button>');
    }
    if (m.message_type === 'image' && m.id) {
        parts.push('<img class="msg-img" src="/api/file/' + m.id + '" alt="Ø¹Ú©Ø³" loading="lazy">');
    }
    if (m.message_type === 'voice' && m.id) {
        var waveId = 'w' + m.id;
        var bars = [];
        for (var i = 0; i < 20; i++) {
            var h = (30 + (m.id + i) % 70) + '%';
            bars.push('<span style="height:' + h + '" data-idx="' + i + '"></span>');
        }
        parts.push(
            '<div class="voice-msg-bubble" data-msg-id="' + m.id + '">' +
            '<button type="button" class="voice-play-btn" aria-label="Ù¾Ø®Ø´">â–¶</button>' +
            '<div class="voice-waveform" id="' + waveId + '">' + bars.join('') + '</div>' +
            '<span class="voice-duration">0:00</span>' +
            '<audio preload="metadata" src="/api/file/' + m.id + '" data-msg-id="' + m.id + '"></audio>' +
            '</div>'
        );
    }
    if (m.message_type === 'file' && m.id && m.file_name) {
        parts.push('<a class="msg-file" href="/api/file/' + m.id + '" download="' + escapeHtml(m.file_name) + '">' + escapeHtml(m.file_name) + '</a>');
    }
    if (m.body) {
        parts.push(escapeHtml(m.body));
    }
    if (parts.length === 0) {
        parts.push('[Ù¾ÛŒØ§Ù…]');
    }
    parts.push('<time>' + escapeHtml(m.created_at) + '</time>');
    if (sent && otherReadUpTo != null && m.id <= otherReadUpTo) {
        parts.push('<span class="msg-read">âœ“âœ“</span>');
    }
    return '<div class="msg ' + cls + '" data-msg-id="' + (m.id || '') + '">' + parts.join('') + '</div>';
}

function loadChat(isPolling) {
    if (!currentOtherId) return;
    var wasAtBottom = !isPolling || (chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 80);
    fetch('/api/chat/' + currentOtherId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                if (!isPolling) chatMessages.innerHTML = '<p class="error">' + escapeHtml(data.error) + '</p>';
                return;
            }
            var maxId = 0;
            data.messages.forEach(function(m) { if (m.id > maxId) maxId = m.id; });
            var sameContent = isPolling && data.messages.length === lastChatMessageCount && maxId === lastChatLastId;
            if (sameContent) {
                if (maxId > 0) {
                    fetch('/api/chat/' + currentOtherId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                        body: JSON.stringify({ read_receipt: true, last_read_message_id: maxId })
                    });
                }
                return;
            }
            var prevLastId = lastChatLastId;
            lastChatMessageCount = data.messages.length;
            lastChatLastId = maxId;
            iBlockedThem = data.i_blocked_them || false;
            if (blockBtn) {
                blockBtn.style.display = 'inline-flex';
                blockBtn.textContent = iBlockedThem ? 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª' : 'Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†';
            }
            var otherReadUpTo = data.other_read_up_to != null ? data.other_read_up_to : null;
            chatMessages.innerHTML = data.messages.map(function(m) { return buildMessageHtml(m, otherReadUpTo); }).join('');
            initVoiceBubbles();
            chatMessages.querySelectorAll('.msg-del').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var mid = parseInt(btn.getAttribute('data-msg-id'), 10);
                    if (mid !== mid) return;
                    fetch('/api/message/' + mid, {
                        method: 'DELETE',
                        headers: { 'X-CSRF-Token': csrfToken }
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        if (res.ok) {
                            var el = chatMessages.querySelector('.msg[data-msg-id="' + mid + '"]');
                            if (el) el.remove();
                        } else { showToast(res.error || 'Ø®Ø·Ø§'); }
                    });
                });
            });
            if (wasAtBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
            if (maxId > 0) {
                fetch('/api/chat/' + currentOtherId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ read_receipt: true, last_read_message_id: maxId })
                });
            }
            if (isPolling && prevLastId > 0 && typeof Notification !== 'undefined' && Notification.permission === 'granted' && document.hidden) {
                var newReceived = data.messages.filter(function(m) { return m.id > prevLastId && m.sender_id !== userId; });
                if (newReceived.length > 0) {
                    var fromName = (currentOtherName && currentOtherName.length > 0) ? currentOtherName : 'ÙØ±Ø³ØªÙ†Ø¯Ù‡';
                    var bodyText;
                    if (newReceived.length === 1) {
                        var msg = newReceived[0];
                        if (msg.message_type === 'image') bodyText = 'Ø¹Ú©Ø³';
                        else if (msg.message_type === 'voice') bodyText = 'ÙˆÛŒØ³';
                        else if (msg.message_type === 'file') bodyText = 'ÙØ§ÛŒÙ„';
                        else bodyText = (msg.body || '').trim().slice(0, 60) || 'Ù¾ÛŒØ§Ù…';
                        if ((msg.body || '').length > 60) bodyText += 'â€¦';
                    } else {
                        bodyText = newReceived.length + ' Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯';
                    }
                    try {
                        var n = new Notification('Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ' + fromName, { body: bodyText, dir: 'rtl', tag: 'msg-' + currentOtherId });
                        n.onclick = function() { window.focus(); n.close(); };
                    } catch (e) {}
                }
            }
            if (!isPolling) startChatPoll();
        });
}

if (blockBtn) {
    blockBtn.addEventListener('click', function() {
        if (!currentOtherId) return;
        var method = iBlockedThem ? 'DELETE' : 'POST';
        fetch('/api/block/' + currentOtherId, {
            method: method,
            headers: { 'X-CSRF-Token': csrfToken }
        }).then(function(r) { return r.json(); }).then(function(res) {
            if (res.ok) {
                iBlockedThem = !iBlockedThem;
                blockBtn.textContent = iBlockedThem ? 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª' : 'Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†';
                showToast(iBlockedThem ? 'Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.' : 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ø´Ø¯.');
            } else { showToast(res.error || 'Ø®Ø·Ø§'); }
        });
    });
}

if (btnNotify) {
    btnNotify.addEventListener('click', function() {
        if (typeof Notification === 'undefined') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
            return;
        }
        if (Notification.permission === 'granted') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø§Ø² Ù‚Ø¨Ù„ ÙØ¹Ø§Ù„ Ø§Ø³Øª');
            return;
        }
        if (Notification.permission === 'denied') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡. Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ù‡ÛŒØ¯.');
            return;
        }
        Notification.requestPermission().then(function(p) {
            if (p === 'granted') showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯');
            else if (p === 'denied') showToast('Ø§Ø¬Ø§Ø²Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯');
        });
    });
}

loadConversations();

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentOtherId) return;
    var body = msgInput.value.trim();
    var btn = chatForm.querySelector('button[type="submit"]');

    if (selectedFile) {
        btn.disabled = true;
        var fd = new FormData();
        fd.append('file', selectedFile);
        fd.append('receiver_id', currentOtherId);
        fd.append('body', body);
        fd.append('csrf_token', csrfToken);
        try {
            var r = await fetch('/api/send', { method: 'POST', body: fd });
            var res = await r.json();
            if (res.ok) {
                msgInput.value = '';
                selectedFile = null;
                fileInput.value = '';
                filePreview.textContent = '';
                loadChat();
            } else {
                showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„');
            }
        } finally {
            btn.disabled = false;
        }
        return;
    }

    if (!body) return;
    btn.disabled = true;
    try {
        var r = await fetch('/api/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ receiver_id: currentOtherId, body: body })
        });
        var res = await r.json();
        if (res.ok) {
            msgInput.value = '';
            loadChat();
        } else {
            showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„');
        }
    } finally {
        btn.disabled = false;
    }
});
</script>
{% endblock %}

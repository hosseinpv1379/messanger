{% extends "base.html" %}
{% block title %}Ù…Ø³Ù†Ø¬Ø± â€” {{ username }}{% endblock %}
{% block extra_css %}
/* â€”â€”â€” Ù¾Ø§Ù„Øª Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… â€”â€”â€” */
.tg-app {
    --tg-blue: #2AABEE;
    --tg-blue-hover: #229ED9;
    --tg-bg: #0E1621;
    --tg-panel: #17212B;
    --tg-surface: #242F3D;
    --tg-text: #FFFFFF;
    --tg-text-secondary: #708499;
    --tg-bubble-sent: #2AABEE;
    --tg-bubble-received: #182533;
    --tg-border: rgba(255,255,255,0.06);
    --tg-input-bg: #242F3D;
    --safe-top: env(safe-area-inset-top, 0);
    --safe-bottom: env(safe-area-inset-bottom, 0);
    --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
}
html.theme-light .tg-app {
    --tg-bg: #FFFFFF;
    --tg-panel: #F0F2F5;
    --tg-surface: #FFFFFF;
    --tg-text: #000000;
    --tg-text-secondary: #707579;
    --tg-bubble-sent: #3390EC;
    --tg-bubble-received: #EFFEDE;
    --tg-border: rgba(0,0,0,0.08);
    --tg-input-bg: #FFFFFF;
}
.tg-app {
    display: flex;
    width: 100%;
    max-width: 100%;
    height: calc(100vh - var(--safe-top) - var(--safe-bottom));
    height: calc(100dvh - var(--safe-top) - var(--safe-bottom));
    background: var(--tg-bg);
    overflow: hidden;
}
.messenger-page { --tg-accent: var(--tg-blue); --tg-accent-dim: rgba(42, 171, 238, 0.15); }
html.theme-light .messenger-page { --tg-accent: var(--tg-blue-hover); --tg-accent-dim: rgba(51, 144, 236, 0.18); }

/* â€”â€”â€” Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§) Ù…Ø«Ù„ ØªÙ„Ú¯Ø±Ø§Ù… â€”â€”â€” */
.tg-sidebar {
    width: 100%;
    max-width: 420px;
    display: flex;
    flex-direction: column;
    background: var(--tg-panel);
    border-left: 1px solid var(--tg-border);
    min-height: 0;
}
@media (min-width: 768px) {
    .tg-sidebar { width: 380px; flex-shrink: 0; }
    .tg-main.has-chat .tg-chat-header .back-btn { display: none; }
}
@media (max-width: 767px) {
    .tg-sidebar.hidden-mobile { display: none !important; }
    .tg-main.hidden-mobile { display: none !important; }
}
.tg-sidebar-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    min-height: 54px;
    background: var(--tg-panel);
    border-bottom: 1px solid var(--tg-border);
}
.tg-icon-btn {
    width: 42px;
    height: 42px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: transparent;
    color: var(--tg-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
}
.tg-icon-btn:hover { background: var(--tg-border); color: var(--tg-text); }
.tg-search-input {
    flex: 1;
    min-width: 0;
    height: 42px;
    padding: 0 1rem;
    border: none;
    border-radius: 21px;
    background: var(--tg-input-bg);
    color: var(--tg-text);
    font-size: 0.95rem;
}
.tg-search-input::placeholder { color: var(--tg-text-secondary); }
.tg-search-input:focus { outline: none; }
.tg-chat-list-wrap {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
}
.tg-chat-list { list-style: none; margin: 0; padding: 0; }
.tg-chat-list .history-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--tg-border);
    cursor: pointer;
    text-align: right;
    background: transparent;
    border-radius: 0;
    margin: 0;
    transition: background 0.15s;
}
.tg-chat-list .history-item:hover { background: rgba(255,255,255,0.04); }
.tg-chat-list .history-item.active { background: var(--tg-surface); }
.tg-chat-list .history-item .h-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--tg-blue), var(--tg-blue-hover));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.15rem;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
}
.tg-chat-list .history-item .h-body { flex: 1; min-width: 0; }
.tg-chat-list .history-item .h-top { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; margin-bottom: 0.15rem; }
.tg-chat-list .history-item .h-username { font-weight: 600; font-size: 0.95rem; color: var(--tg-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tg-chat-list .history-item .h-preview { font-size: 0.85rem; color: var(--tg-text-secondary); line-height: 1.35; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tg-chat-list .history-item .h-time { font-size: 0.75rem; color: var(--tg-text-secondary); flex-shrink: 0; }
.tg-chat-list .history-item .h-delete { margin-right: auto; }
.tg-chat-list-empty {
    padding: 2rem 1.5rem;
    text-align: center;
    color: var(--tg-text-secondary);
    font-size: 0.9rem;
    line-height: 1.7;
}

/* â€”â€”â€” Ù†Ø§Ø­ÛŒÙ‡Ù” Ø§ØµÙ„ÛŒ Ùˆ Ù‡Ø¯Ø± Ú†Øª â€”â€”â€” */
.tg-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
    background: var(--tg-bg);
}
.tg-chat-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    min-height: 54px;
    background: var(--tg-panel);
    border-bottom: 1px solid var(--tg-border);
}
.tg-chat-header .back-btn {
    display: inline-flex;
    font-size: 1.75rem;
    line-height: 1;
}
@media (min-width: 768px) { .tg-chat-header .back-btn { display: none; } }
.tg-chat-header-title {
    flex: 1;
    font-weight: 600;
    font-size: 1rem;
    color: var(--tg-text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.tg-chat-header-actions { display: flex; align-items: center; gap: 0.25rem; }
.tg-chat-header-actions .chat-with-actions { display: flex; align-items: center; gap: 0.25rem; }
.tg-welcome {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    text-align: center;
}
.tg-welcome-icon { font-size: 4rem; opacity: 0.4; margin-bottom: 1rem; }
.tg-welcome-title { margin: 0 0 0.5rem; font-size: 1.5rem; font-weight: 700; color: var(--tg-text); }
.tg-welcome-desc { margin: 0; font-size: 0.95rem; color: var(--tg-text-secondary); line-height: 1.6; max-width: 320px; }
.chat-body { flex: 1; display: flex; flex-direction: column; min-height: 0; }

/* â€”â€”â€” Ù…Ù†ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø±ÛŒ (Ø¯Ø±Ø§ÙˆØ±) â€”â€”â€” */
.drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s var(--ease), visibility 0.25s var(--ease);
}
.drawer-overlay.open {
    opacity: 1;
    visibility: visible;
}
.drawer {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: min(300px, 85vw);
    max-width: 300px;
    background: linear-gradient(180deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.99) 100%);
    box-shadow: -8px 0 32px rgba(0,0,0,0.4);
    z-index: 201;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s var(--ease);
    border-left: 1px solid rgba(71, 85, 105, 0.4);
}
.drawer-overlay.open .drawer {
    transform: translateX(0);
}
.drawer-header {
    padding: 1.25rem 1.25rem 1rem;
    border-bottom: 1px solid rgba(71, 85, 105, 0.35);
    font-weight: 700;
    font-size: 1.1rem;
}
.drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 0;
}
.drawer-item {
    display: block;
    width: 100%;
    padding: 0.9rem 1.25rem;
    text-align: right;
    border: none;
    background: none;
    color: var(--text);
    font-family: inherit;
    font-size: 1rem;
    cursor: pointer;
    transition: background var(--transition);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.drawer-item:hover { background: rgba(6, 182, 212, 0.12); }
.drawer-item .icon { font-size: 1.25rem; }
.drawer-section-title {
    padding: 0.6rem 1.25rem 0.35rem;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-soft);
    text-transform: uppercase;
    letter-spacing: 0.02em;
}
.drawer-new-chat {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(71, 85, 105, 0.3);
}
.drawer-new-chat label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-soft); }
.drawer-new-chat input {
    width: 100%;
    margin: 0 0 0.5rem 0;
    border-radius: var(--radius-sm);
    padding: 0.6rem 1rem;
    box-sizing: border-box;
}
.drawer-new-chat .open-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; }
.drawer-new-chat .btn { width: 100%; margin-top: 0.25rem; }
/* Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¯Ø±Ø§ÙˆØ± */
.drawer-new-group { padding: 0 1.25rem 1rem; }
.drawer-new-group .drawer-item-action { margin-bottom: 0.35rem; }
.drawer-create-group-form,
.drawer-invite-result,
.drawer-join-group { margin-top: 0.5rem; }
.drawer-create-group-form input,
.drawer-join-group input { width: 100%; margin-bottom: 0.35rem; }
.drawer-create-group-form .btn,
.drawer-join-group .btn { width: 100%; }
.invite-link-label { font-size: 0.85rem; color: var(--text-soft); margin: 0.5rem 0 0.25rem; }
.invite-link-wrap { display: flex; gap: 0.35rem; margin-bottom: 0.35rem; }
.invite-link-wrap input { flex: 1; font-size: 0.8rem; }
.drawer-groups-list { list-style: none; margin: 0.5rem 0 0; padding: 0; }
.drawer-groups-list .history-item { margin-bottom: 0.35rem; }
.drawer-groups-list .history-item .h-avatar { background: linear-gradient(135deg, var(--tg-accent), #229ED9); }

/* â€”â€”â€” ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø¯Ø±ÙˆÙ† Ù…Ø³Ù†Ø¬Ø±) â€”â€”â€” */
.settings-panel {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 1.25rem;
    animation: fadeIn 0.3s var(--ease);
}
.settings-panel.visible { display: flex; }
.settings-panel h2 {
    margin: 0 0 1.25rem 0;
    font-size: 1.35rem;
}
.settings-group {
    margin-bottom: 1.5rem;
}
.settings-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: rgba(51, 65, 85, 0.4);
    border-radius: 14px;
    margin-bottom: 0.5rem;
    border: 1px solid transparent;
    transition: background var(--transition);
}
.settings-item a {
    color: inherit;
    text-decoration: none;
    flex: 1;
}
.settings-item:hover { background: rgba(51, 65, 85, 0.6); }
.settings-item .icon { font-size: 1.2rem; margin-left: 0.5rem; }
.settings-item-toggle { display: flex; align-items: center; justify-content: space-between; }
.theme-switch { display: flex; gap: 0.25rem; }
.theme-opt {
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-soft);
    font-size: 0.9rem;
    cursor: pointer;
    transition: background .2s, color .2s, border-color .2s;
}
.theme-opt:hover { background: rgba(255,255,255,0.08); color: var(--text); }
.theme-opt.active { background: var(--tg-accent); color: #fff; border-color: var(--tg-accent); }
.settings-item-static { flex-direction: column; align-items: flex-start; }
.settings-item-static .icon { display: none; }
.settings-item-static span { font-size: 0.85rem; color: var(--text-soft); line-height: 1.6; }
.settings-version { font-size: 0.8rem; color: var(--text-soft); opacity: 0.8; padding-top: 0.5rem; }
html.theme-light .theme-opt { border-color: rgba(100, 116, 139, 0.5); }
html.theme-light .theme-opt:hover { background: rgba(0,0,0,0.06); }
html.theme-light .theme-opt.active { background: var(--tg-accent); color: #fff; border-color: var(--tg-accent); }

/* â€”â€”â€” ØªÙ… Ø±ÙˆØ´Ù† ØªÙ„Ú¯Ø±Ø§Ù… â€”â€”â€” */
html.theme-light .tg-app .tg-sidebar-header,
html.theme-light .tg-app .tg-chat-header { border-bottom-color: var(--tg-border); }
html.theme-light .tg-app .tg-chat-list .history-item:hover { background: rgba(0,0,0,0.04); }
html.theme-light .tg-app .tg-chat-list .history-item.active { background: var(--tg-surface); }
html.theme-light .drawer-overlay { background: rgba(0,0,0,0.35); }
html.theme-light .drawer { box-shadow: -8px 0 32px rgba(0,0,0,0.15); }
html.theme-light .drawer-header { border-bottom-color: rgba(148, 163, 184, 0.35); }
html.theme-light .drawer-item:hover { background: var(--tg-accent-dim); }
html.theme-light .drawer-new-chat { border-bottom-color: rgba(148, 163, 184, 0.35); }
html.theme-light .settings-item { background: rgba(226, 232, 240, 0.9); border-color: rgba(148, 163, 184, 0.25); }
html.theme-light .settings-item:hover { background: rgba(203, 213, 225, 0.95); }
html.theme-light .chat-search-in-chat { background: rgba(241, 245, 249, 0.95); }
html.theme-light .chat-form { border-top-color: var(--tg-border); }
html.theme-light .composer-attachment-strip { background: var(--tg-input-bg); }
html.theme-light .msg .msg-del:hover { background: rgba(0,0,0,0.1); }
html.theme-light .mic-permission-card { background: linear-gradient(145deg, rgba(51, 144, 236, 0.1) 0%, #fff 100%); border-color: rgba(51, 144, 236, 0.3); }
html.theme-light .mic-permission-card.insecure { background: linear-gradient(145deg, rgba(251, 191, 36, 0.12) 0%, #fff 100%); border-color: rgba(251, 191, 36, 0.35); }
html.theme-light .voice-recording { background: #fff; border-color: rgba(220, 38, 38, 0.3); }
html.theme-light .voice-preview { background: var(--tg-panel); border-color: var(--tg-border); }
html.theme-light .pwa-install-banner { box-shadow: 0 -4px 24px rgba(0,0,0,0.1); }

.settings-about {
    font-size: 0.9rem;
    color: var(--text-soft);
    line-height: 1.7;
    padding: 1rem 0;
}
.chat-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    animation: fadeIn 0.3s var(--ease);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.chat-placeholder .history-section {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.25rem;
    -webkit-overflow-scrolling: touch;
}
.chat-placeholder .history-title {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--text-soft);
    margin-bottom: 0.75rem;
    padding: 0.25rem 0;
}
.chat-placeholder .history-search {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}
.chat-placeholder .history-search input {
    flex: 1;
    margin: 0;
    border-radius: var(--radius-pill);
    padding: 0.6rem 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
}
.chat-placeholder .history-list { list-style: none; margin: 0; padding: 0; }
.chat-placeholder .history-item {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 0.9rem 1rem;
    border-radius: 14px;
    margin-bottom: 0.35rem;
    background: rgba(255,255,255,0.03);
    border: 1px solid transparent;
    cursor: pointer;
    text-align: right;
    transition: all var(--transition);
    animation: fadeIn 0.35s var(--ease) backwards;
}
.chat-placeholder .history-item:hover {
    background: var(--tg-accent-dim);
    border-color: rgba(42, 171, 238, 0.25);
}
.chat-placeholder .history-item.active {
    background: var(--tg-accent-dim);
    border-color: rgba(42, 171, 238, 0.4);
}
.chat-placeholder .history-item:active { transform: scale(0.99); }
.chat-placeholder .history-item .h-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--tg-accent), #229ED9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
}
.chat-placeholder .history-item .h-body { flex: 1; min-width: 0; }
.chat-placeholder .history-item .h-username { font-weight: 700; margin-bottom: 0.2rem; font-size: 1rem; }
.chat-placeholder .history-item .h-preview { font-size: 0.85rem; color: var(--text-soft); line-height: 1.4; }
.chat-placeholder .history-item .h-time { font-size: 0.75rem; color: var(--text-soft); margin-top: 0.25rem; opacity: 0.9; }
.chat-placeholder .history-item .h-delete {
    padding: 0.35rem;
    border-radius: 10px;
    border: none;
    background: transparent;
    color: var(--text-soft);
    cursor: pointer;
    opacity: 0.7;
    transition: opacity var(--transition), color var(--transition);
}
.chat-placeholder .history-item .h-delete:hover { opacity: 1; color: var(--danger); }
.chat-search-in-chat {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.5);
    display: none;
}
.chat-search-in-chat.visible { display: block; }
.chat-search-in-chat input {
    width: 100%;
    margin: 0;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-pill);
    font-size: 0.95rem;
}
.chat-with-actions { display: flex; align-items: center; gap: 0.35rem; }
.chat-with-actions .btn-icon-small {
    width: 36px;
    height: 36px;
    padding: 0;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: background var(--transition);
}
.chat-with-actions .btn-icon-small:hover { background: rgba(255,255,255,0.15); }
.chat-placeholder .history-empty {
    color: var(--text-soft);
    padding: 2.5rem 1rem;
    text-align: center;
    line-height: 1.8;
    font-size: 0.95rem;
}
.chat-active {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    animation: fadeIn 0.35s var(--ease);
}
.chat-active.visible { display: flex; }
.chat-with {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    min-height: 54px;
    border-bottom: 1px solid var(--tg-border);
    font-weight: 600;
    font-size: 1rem;
    background: var(--tg-panel);
}
.chat-with .chat-with-actions { display: flex; align-items: center; gap: 0.25rem; }
.chat-with .btn-sm { padding: 0.35rem 0.65rem; font-size: 0.8rem; border-radius: 8px; }
.chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0.75rem 1rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    -webkit-overflow-scrolling: touch;
    background: var(--tg-bg);
}
html.theme-light .chat-messages {
    background: var(--tg-bg);
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L30 60M0 30L60 30' stroke='%23e5e5e5' stroke-width='0.5' fill='none'/%3E%3C/svg%3E");
}
.chat-messages .msg-date-sep {
    text-align: center;
    margin: 0.75rem 0;
}
.chat-messages .msg-date-sep span {
    padding: 0.25rem 0.75rem;
    border-radius: 8px;
    font-size: 0.8rem;
    color: var(--tg-text-secondary);
    background: var(--tg-surface);
}
.chat-messages .msg {
    max-width: 75%;
    padding: 0.5rem 0.75rem 0.35rem;
    border-radius: 12px;
    line-height: 1.5;
    word-break: break-word;
    transition: transform 0.15s var(--ease);
    animation: msgIn 0.2s var(--ease);
    position: relative;
}
@keyframes msgIn {
    from { opacity: 0; transform: scale(0.97); }
    to { opacity: 1; transform: scale(1); }
}
.chat-messages .msg.sent {
    align-self: flex-end;
    background: var(--tg-bubble-sent);
    color: #fff;
    border-bottom-left-radius: 4px;
}
.chat-messages .msg.received {
    align-self: flex-start;
    background: var(--tg-bubble-received);
    color: var(--tg-text);
    border-bottom-right-radius: 4px;
}
.chat-messages .msg.hidden-by-search { display: none !important; }
.chat-messages .msg .msg-meta {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.35rem;
    margin-top: 0.25rem;
}
.chat-messages .msg time {
    font-size: 0.7rem;
    opacity: 0.85;
}
.chat-messages .msg .msg-read { font-size: 0.75rem; opacity: 0.9; }
.chat-messages .msg .msg-img {
    max-width: 100%;
    border-radius: 10px;
    display: block;
    margin-bottom: 0.3rem;
}
.chat-messages .msg .msg-file { color: inherit; text-decoration: underline; opacity: 0.95; }
.msg .msg-del {
    position: absolute;
    left: 0.25rem;
    top: 0.25rem;
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
    border-radius: 6px;
    opacity: 0.8;
    transition: opacity 0.2s, background 0.2s;
}
.msg .msg-del:hover { opacity: 1; background: rgba(0,0,0,0.15); }
.msg .msg-sender-name { font-size: 0.75rem; font-weight: 600; color: var(--tg-blue); margin-bottom: 0.15rem; display: block; }
/* â€”â€”â€” ÙØ±Ù… Ø§Ø±Ø³Ø§Ù„ (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€” */
.chat-form {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 0.5rem 0.75rem;
    padding-bottom: max(0.5rem, var(--safe-bottom));
    border-top: 1px solid var(--tg-border);
    background: var(--tg-panel);
}
/* Ù†ÙˆØ§Ø± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„/Ø¹Ú©Ø³ */
.composer-attachment-strip {
    display: none;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-radius: 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    animation: composerSlideIn 0.2s var(--ease);
}
.composer-attachment-strip.visible { display: flex; }
@keyframes composerSlideIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
}
.composer-attachment-preview {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}
.composer-attachment-thumb {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--bg-soft);
}
.composer-attachment-thumb[src=""] { display: none !important; }
.composer-attachment-icon {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: var(--tg-accent-dim);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    flex-shrink: 0;
}
.composer-attachment-thumb[src]:not([src=""]) ~ .composer-attachment-icon { display: none !important; }
.composer-attachment-name {
    flex: 1;
    min-width: 0;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.composer-attachment-remove {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    font-size: 1.25rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.2s, transform 0.15s var(--ease);
}
.composer-attachment-remove:hover {
    background: rgba(239, 68, 68, 0.35);
    transform: scale(1.08);
}
/* Ø±Ø¯ÛŒÙ Ø§ØµÙ„ÛŒ Ú©Ø§Ù…Ù¾ÙˆØ²Ø± */
.composer-row {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    min-height: 44px;
    padding: 0.3rem 0.4rem 0.3rem 0.5rem;
    border-radius: 22px;
    background: var(--tg-input-bg);
    border: 1px solid var(--tg-border);
    transition: border-color 0.2s, box-shadow 0.2s;
}
.chat-form:focus-within .composer-row {
    border-color: var(--tg-blue);
    box-shadow: 0 0 0 1px var(--tg-blue);
}
.composer-input {
    flex: 1;
    min-width: 0;
    margin: 0;
    padding: 0.4rem 0.5rem;
    border: none;
    border-radius: 0;
    background: transparent;
    color: var(--tg-text);
    font-size: 0.95rem;
    font-family: inherit;
}
.composer-input::placeholder { color: var(--tg-text-secondary); }
.composer-input:focus { outline: none; }
.composer-btn {
    width: 38px;
    height: 38px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: transparent;
    color: var(--tg-text-secondary);
    font-size: 1.15rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.2s, color 0.2s;
}
.composer-btn:hover {
    background: var(--tg-border);
    color: var(--tg-text);
}
.composer-btn-attach { font-size: 1.1rem; }
.composer-btn-voice { font-size: 1.1rem; }
.composer-btn-voice.recording {
    background: #e53935;
    color: #fff;
    animation: btnVoicePulse 1.5s ease-in-out infinite;
}
.composer-btn-voice.recording:hover { color: #fff; }
@keyframes btnVoicePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}
.composer-send {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: var(--tg-blue);
    color: #fff;
    font-size: 1.1rem;
    font-family: inherit;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s, background 0.2s;
}
.composer-send:hover { background: var(--tg-blue-hover); transform: scale(1.05); }
.composer-send:active { transform: scale(0.98); }
.composer-send-icon { opacity: 0.95; }
.composer-send-text { display: none; }

/* â€”â€”â€” Ú©Ø§Ø±Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† â€”â€”â€” */
.mic-permission-card {
    margin: 0 1.25rem 1rem;
    padding: 1.1rem 1.25rem;
    border-radius: 18px;
    background: linear-gradient(145deg, rgba(6, 182, 212, 0.12) 0%, rgba(15, 23, 42, 0.85) 100%);
    border: 1px solid rgba(6, 182, 212, 0.25);
    display: flex;
    align-items: center;
    gap: 1rem;
    animation: fadeIn 0.4s var(--ease);
}
.mic-permission-card.insecure {
    background: linear-gradient(145deg, rgba(251, 191, 36, 0.1) 0%, rgba(15, 23, 42, 0.85) 100%);
    border-color: rgba(251, 191, 36, 0.3);
}
.mic-permission-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(6, 182, 212, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}
.mic-permission-card.insecure .mic-permission-icon { background: rgba(251, 191, 36, 0.2); }
.mic-permission-text { flex: 1; min-width: 0; }
.mic-permission-text strong { display: block; margin-bottom: 0.2rem; font-size: 0.95rem; }
.mic-permission-text span { font-size: 0.85rem; color: var(--text-soft); line-height: 1.45; }
.mic-permission-card .btn { flex-shrink: 0; white-space: nowrap; }

/* â€”â€”â€” Ù†ÙˆØ§Ø± Ø¶Ø¨Ø· ÙˆÛŒØ³ (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€” */
.voice-recording {
    display: none;
    align-items: center;
    gap: 0.85rem;
    padding: 0.65rem 1rem;
    margin: 0;
    border-radius: 16px;
    background: var(--surface);
    border: 1px solid rgba(239, 68, 68, 0.3);
    animation: composerSlideIn 0.2s var(--ease);
}
.voice-recording .voice-recording-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ef4444;
    flex-shrink: 0;
    animation: voicePulse 1s ease-in-out infinite;
}
@keyframes voicePulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.1); } }
.voice-recording .voice-recording-time {
    font-variant-numeric: tabular-nums;
    font-weight: 700;
    font-size: 1rem;
    min-width: 2.8em;
}
.voice-recording .voice-recording-label {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-soft);
}
.voice-recording-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.voice-recording-actions .btn-icon {
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    transition: transform 0.15s var(--ease), background 0.2s var(--ease);
}
.voice-recording-actions .btn-icon:hover { transform: scale(1.08); }
.voice-recording-actions .btn-icon-cancel {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}
.voice-recording-actions .btn-icon-send {
    background: var(--accent);
    color: #fff;
}

/* â€”â€”â€” Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙˆÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€” */
.voice-preview {
    display: none;
    flex-direction: column;
    gap: 0.65rem;
    padding: 0.75rem 1rem;
    margin: 0;
    border-radius: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    animation: composerSlideIn 0.25s var(--ease);
}
.voice-preview .voice-preview-player {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.voice-preview .voice-preview-play-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--tg-accent), #229ED9);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
    transition: transform 0.15s var(--ease), box-shadow 0.2s var(--ease);
}
.voice-preview .voice-preview-play-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 18px var(--tg-accent-dim);
}
.voice-preview .voice-preview-play-btn.playing {
    background: var(--surface-hover);
    color: var(--text);
}
.voice-preview-progress-wrap {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: rgba(71, 85, 105, 0.4);
    overflow: hidden;
}
.voice-preview-progress {
    height: 100%;
    width: 0%;
    background: var(--tg-accent);
    border-radius: 3px;
    transition: width 0.1s linear;
}
.voice-preview-duration {
    font-variant-numeric: tabular-nums;
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 2.5em;
    color: var(--text-soft);
}
.voice-preview-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}
.voice-preview-actions .btn { min-height: 38px; padding: 0.4rem 0.9rem; font-size: 0.9rem; }
.voice-preview-actions .btn-sm { min-height: 36px; }

/* â€”â€”â€” Ø­Ø¨Ø§Ø¨ ÙˆÛŒØ³ Ø¯Ø± Ú†Øª (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€” */
.voice-msg-bubble {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.9rem 0.6rem 0.6rem;
    min-width: 0;
    max-width: 280px;
}
.voice-msg-bubble .voice-play-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: inherit;
    font-size: 1rem;
    flex-shrink: 0;
    transition: background 0.2s var(--ease), transform 0.15s var(--ease);
}
.voice-msg-bubble .voice-play-btn:hover { background: rgba(255,255,255,0.35); transform: scale(1.05); }
.voice-msg-bubble .voice-waveform {
    flex: 1;
    height: 32px;
    display: flex;
    align-items: center;
    gap: 3px;
    min-width: 0;
}
.voice-msg-bubble .voice-waveform span {
    width: 4px;
    min-width: 4px;
    border-radius: 2px;
    background: currentColor;
    opacity: 0.7;
    height: 50%;
    align-self: center;
    transition: height 0.15s var(--ease);
}
.voice-msg-bubble .voice-waveform span.active { height: 100%; opacity: 1; }
.voice-msg-bubble .voice-duration {
    font-variant-numeric: tabular-nums;
    font-size: 0.8rem;
    opacity: 0.9;
    flex-shrink: 0;
}
.msg.sent .voice-msg-bubble .voice-play-btn { background: rgba(255,255,255,0.3); }
.msg.received .voice-msg-bubble .voice-play-btn { background: rgba(0,0,0,0.15); }
.msg-voice {
    display: none;
}
.chat-form.voice-mode .composer-row,
.chat-form.voice-mode .composer-attachment-strip {
    display: none !important;
}
.loading { opacity: 0.7; pointer-events: none; }
.toast {
    position: fixed;
    bottom: max(1.5rem, calc(var(--safe-bottom) + 1rem));
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--danger), #e11d48);
    color: #fff;
    padding: 0.9rem 1.5rem;
    border-radius: 14px;
    font-size: 0.95rem;
    font-weight: 500;
    z-index: 100;
    opacity: 0;
    box-shadow: 0 10px 40px rgba(244, 63, 94, 0.4);
    transition: transform 0.35s var(--ease), opacity 0.35s var(--ease);
}
.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
/* Ø¨Ù†Ø± Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ (Ù…ÙˆØ¨Ø§ÛŒÙ„) */
.pwa-install-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.9rem 1rem;
    padding-bottom: max(0.9rem, env(safe-area-inset-bottom));
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-top: 1px solid rgba(71, 85, 105, 0.5);
    box-shadow: 0 -4px 24px rgba(0,0,0,0.3);
    z-index: 150;
    display: none;
    align-items: center;
    gap: 0.75rem;
    animation: slideUpBanner 0.35s var(--ease);
}
.pwa-install-banner.visible { display: flex; flex-wrap: wrap; }
@keyframes slideUpBanner {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.pwa-install-banner .pwa-install-text {
    flex: 1;
    min-width: 0;
    font-size: 0.9rem;
    line-height: 1.4;
}
.pwa-install-banner .pwa-install-text strong { display: block; margin-bottom: 0.2rem; }
.pwa-install-banner .pwa-install-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.pwa-install-banner .pwa-install-actions .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
.pwa-install-banner .pwa-dismiss { background: transparent; color: var(--text-soft); padding: 0.35rem; border: none; cursor: pointer; font-size: 1.1rem; }
@media (max-width: 500px) {
    .messenger-page { border-radius: 0; max-height: none; }
    .chat-messages .msg { max-width: 90%; }
}
{% endblock %}
{% block body %}
<div class="tg-app" id="tgApp">
    <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ØªÙ„Ú¯Ø±Ø§Ù…â€ŒÙˆØ§Ø±: Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ -->
    <aside class="tg-sidebar" id="tgSidebar">
        <header class="tg-sidebar-header">
            <button type="button" class="tg-icon-btn hamburger-btn" id="hamburgerBtn" aria-label="Ù…Ù†Ùˆ">â‰¡</button>
            <input type="text" class="tg-search-input" id="convoSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ" autocomplete="off">
        </header>
        <div class="tg-chat-list-wrap">
            <ul class="tg-chat-list" id="historyList"></ul>
            <div class="tg-chat-list-empty" id="historyEmpty" style="display: none;">
                Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.<br>Ø§Ø² Ù…Ù†Ùˆ Â«Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯Â» Ø¨Ø²Ù†ÛŒØ¯.
            </div>
        </div>
    </aside>
    <!-- Ù†Ø§Ø­ÛŒÙ‡Ù” Ø§ØµÙ„ÛŒ: Ù‡Ø¯Ø± + Ú†Øª ÛŒØ§ Ø®Ø§Ù„ÛŒ -->
    <main class="tg-main" id="tgMain">
        <header class="tg-chat-header" id="tgChatHeader">
            <button type="button" class="tg-icon-btn back-btn" id="backBtn" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª">â€¹</button>
            <span class="tg-chat-header-title" id="chatHeaderTitle">Ù…Ø³Ù†Ø¬Ø±</span>
            <div class="tg-chat-header-actions" id="headerActions">
                <div class="chat-with-actions chat-actions-1-1" id="chatHeaderActions1" style="display: none;">
                    <button type="button" class="tg-icon-btn" id="chatSearchToggle" title="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú†Øª">ğŸ”</button>
                    <button type="button" class="tg-icon-btn" id="chatClearChatBtn" title="Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ">ğŸ—‘</button>
                    <button type="button" class="btn btn-ghost btn-sm" id="blockBtn" style="display: none;">Ù…Ø³Ø¯ÙˆØ¯</button>
                </div>
                <div class="chat-with-actions chat-actions-group" id="chatHeaderActionsGroup" style="display: none;">
                    <button type="button" class="btn btn-ghost btn-sm" id="groupInviteLinkBtn" title="Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª">ğŸ”—</button>
                    <button type="button" class="btn btn-ghost btn-sm" id="groupLeaveBtn" title="ØªØ±Ú© Ú¯Ø±ÙˆÙ‡">ØªØ±Ú©</button>
                </div>
            </div>
        </header>
    <div class="chat-body">
        <div class="chat-placeholder" id="chatPlaceholder">
            <div class="tg-welcome" id="tgWelcome">
                <div class="tg-welcome-icon">âœˆ</div>
                <h2 class="tg-welcome-title">Ù…Ø³Ù†Ø¬Ø±</h2>
                <p class="tg-welcome-desc">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ© Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù…Ù†Ùˆ Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯.</p>
            </div>
        </div>
        <div class="settings-panel" id="settingsPanel">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="settings-group">
                <div class="settings-item settings-item-toggle">
                    <span>Ø¸Ø§Ù‡Ø±</span>
                    <div class="theme-switch">
                        <button type="button" class="theme-opt active" id="themeDark" data-theme="dark">ØªØ§Ø±ÛŒÚ©</button>
                        <button type="button" class="theme-opt" id="themeLight" data-theme="light">Ø±ÙˆØ´Ù†</button>
                    </div>
                </div>
                <div class="settings-item">
                    <a href="{{ url_for('user_change_password') }}">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</a>
                    <span class="icon">â€º</span>
                </div>
                <div class="settings-item">
                    <span>Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</span>
                    <button type="button" class="btn btn-secondary btn-sm" id="btnNotifySettings">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-item">
                    <span>Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ</span>
                    <span class="icon">â€º</span>
                </div>
                <div class="settings-item settings-item-static">
                    <span>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú†Øª Ø¯Ùˆ Ù†ÙØ±Ù‡ Ø¨Ø§ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø§Ù†ØªÙ‡Ø§â€‘Ø¨Ù‡â€‘Ø§Ù†ØªÙ‡Ø§ (E2EE) Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯Ø› Ø³Ø±ÙˆØ± Ùˆ Ø§Ø¯Ù…ÛŒÙ† Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯ (Ù…Ø´Ø§Ø¨Ù‡ Ú†Øª Ù…Ø®ÙÛŒ ØªÙ„Ú¯Ø±Ø§Ù…).</span>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-item">
                    <a href="{{ url_for('user_delete_account') }}">Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</a>
                    <span class="icon">â€º</span>
                </div>
            </div>
            <div class="settings-about">
                Ù…Ø³Ù†Ø¬Ø± ØªØ­Øª ÙˆØ¨ â€” Ú†Øª Ø¯Ùˆ Ù†ÙØ±Ù‡ Ø¨Ø§ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø§Ù†ØªÙ‡Ø§â€‘Ø¨Ù‡â€‘Ø§Ù†ØªÙ‡Ø§ (E2EE).
            </div>
            <div class="settings-version">Ù†Ø³Ø®Ù‡ Û±.Û°</div>
        </div>
        <div class="chat-active" id="chatActive">
            <div class="chat-search-in-chat" id="chatSearchInChat">
                <input type="text" id="chatSearchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ..." autocomplete="off">
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <!-- Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† (ÛŒÚ©â€ŒØ¨Ø§Ø± Ù†Ù…Ø§ÛŒØ´) -->
            <div class="mic-permission-card" id="micPermissionCard" style="display: none;">
                <div class="mic-permission-icon" aria-hidden="true">ğŸ¤</div>
                <div class="mic-permission-text">
                    <strong>Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ</strong>
                    <span id="micPermissionDesc">Ø§Ø¬Ø§Ø²Ù‡Ù” Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ³ Ø¶Ø¨Ø· Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</span>
                </div>
                <button type="button" class="btn" id="btnGrantMic">Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†</button>
            </div>
            <form class="chat-form" id="chatForm">
                <!-- Ù†ÙˆØ§Ø± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ (Ù…Ø«Ù„ ØªÙ„Ú¯Ø±Ø§Ù…) -->
                <div class="composer-attachment-strip" id="attachmentStrip">
                    <div class="composer-attachment-preview">
                        <img class="composer-attachment-thumb" id="attachmentThumb" alt="">
                        <span class="composer-attachment-icon" id="attachmentFileIcon">ğŸ“„</span>
                        <span class="composer-attachment-name" id="attachmentName"></span>
                        <button type="button" class="composer-attachment-remove" id="attachmentRemove" title="Ø­Ø°Ù ÙØ§ÛŒÙ„" aria-label="Ø­Ø°Ù">Ã—</button>
                    </div>
                </div>
                <!-- Ù†ÙˆØ§Ø± Ø¶Ø¨Ø· ÙˆÛŒØ³ -->
                <div class="voice-recording" id="voiceRecording">
                    <span class="voice-recording-dot" aria-hidden="true"></span>
                    <span class="voice-recording-time" id="voiceRecordingTime">0:00</span>
                    <span class="voice-recording-label">Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·...</span>
                    <div class="voice-recording-actions">
                        <button type="button" class="btn-icon btn-icon-cancel" id="btnCancelRecording" title="Ù„ØºÙˆ">ğŸ—‘</button>
                        <button type="button" class="btn-icon btn-icon-send" id="btnStopVoice" title="Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³">âœ“</button>
                    </div>
                </div>
                <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙˆÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ -->
                <div class="voice-preview" id="voicePreview">
                    <div class="voice-preview-player">
                        <button type="button" class="voice-preview-play-btn" id="voicePreviewPlayBtn" title="Ù¾Ø®Ø´" aria-label="Ù¾Ø®Ø´">â–¶</button>
                        <div class="voice-preview-progress-wrap">
                            <div class="voice-preview-progress" id="voicePreviewProgress"></div>
                        </div>
                        <span class="voice-preview-duration" id="voicePreviewDuration">0:00</span>
                    </div>
                    <div class="voice-preview-actions">
                        <button type="button" class="btn btn-ghost btn-sm" id="btnCancelVoice">Ø­Ø°Ù</button>
                        <button type="button" class="btn btn-sm" id="btnSendVoice">Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³</button>
                    </div>
                </div>
                <!-- Ø±Ø¯ÛŒÙ Ø§ØµÙ„ÛŒ: ÙˆØ±ÙˆØ¯ÛŒ + Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
                <div class="composer-row">
                    <input type="text" id="msgInput" class="composer-input" placeholder="Ù¾ÛŒØ§Ù…..." autocomplete="off" maxlength="4096">
                    <button type="button" class="composer-btn composer-btn-attach" id="btnAttach" title="Ø¹Ú©Ø³ ÛŒØ§ ÙØ§ÛŒÙ„" aria-label="Ù¾ÛŒÙˆØ³Øª">ğŸ“</button>
                    <button type="button" class="composer-btn composer-btn-voice" id="btnVoice" title="Ø¶Ø¨Ø· ÙˆÛŒØ³" aria-label="Ø¶Ø¨Ø· ÙˆÛŒØ³">ğŸ¤</button>
                    <button type="submit" class="composer-send" id="btnSend" title="Ø§Ø±Ø³Ø§Ù„" aria-label="Ø§Ø±Ø³Ø§Ù„">
                        <span class="composer-send-icon">â¤</span>
                        <span class="composer-send-text">Ø§Ø±Ø³Ø§Ù„</span>
                    </button>
                </div>
                <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar,.mp3,.mp4,.webm,.ogg,.wav,.m4a" style="display: none;">
            </form>
            <audio id="voicePreviewAudio" preload="metadata" style="display: none;"></audio>
        </div>
    </div>
    </main>
</div>
<div class="drawer-overlay" id="drawerOverlay">
    <div class="drawer">
        <div class="drawer-header">Ù…Ù†Ùˆ</div>
        <div class="drawer-new-chat">
            <label for="drawerUsername">Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯</label>
            <input type="text" id="drawerUsername" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù" autocomplete="off" dir="ltr" style="text-align: left;">
            <button type="button" class="btn" id="drawerOpenChat">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª</button>
            <span class="open-error" id="drawerOpenError"></span>
        </div>
        <div class="drawer-section-title">Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§</div>
        <div class="drawer-new-group">
            <button type="button" class="drawer-item drawer-item-action" id="drawerNewGroupBtn">
                <span class="icon">â•</span>
                <span>Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯</span>
            </button>
            <div class="drawer-create-group-form" id="drawerCreateGroupForm" style="display: none;">
                <input type="text" id="drawerGroupName" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡" maxlength="128">
                <button type="button" class="btn btn-sm" id="drawerCreateGroupSubmit">Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡</button>
                <span class="open-error" id="drawerGroupError"></span>
            </div>
            <div class="drawer-invite-result" id="drawerInviteResult" style="display: none;">
                <p class="invite-link-label">Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª (Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯):</p>
                <div class="invite-link-wrap">
                    <input type="text" id="drawerInviteLink" readonly>
                    <button type="button" class="btn btn-sm" id="drawerCopyInviteLink">Ú©Ù¾ÛŒ</button>
                </div>
                <button type="button" class="btn btn-ghost btn-sm" id="drawerOpenGroupAfterCreate">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú¯Ø±ÙˆÙ‡</button>
            </div>
            <div class="drawer-join-group">
                <input type="text" id="drawerJoinCode" placeholder="Ú©Ø¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª" dir="ltr" style="text-align: left;">
                <button type="button" class="btn btn-sm" id="drawerJoinGroupBtn">Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú¯Ø±ÙˆÙ‡</button>
                <span class="open-error" id="drawerJoinError"></span>
            </div>
            <ul class="drawer-groups-list" id="groupsList"></ul>
        </div>
        <div class="drawer-section-title">Ù…Ù†Ùˆ</div>
        <div class="drawer-body">
            <button type="button" class="drawer-item" id="drawerConversations">
                <span class="icon">ğŸ’¬</span>
                <span>Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</span>
            </button>
            <button type="button" class="drawer-item" id="drawerSettings">
                <span class="icon">âš™</span>
                <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
            </button>
            <a href="{{ url_for('logout') }}" class="drawer-item">
                <span class="icon">â‹</span>
                <span>Ø®Ø±ÙˆØ¬</span>
            </a>
        </div>
    </div>
</div>
<div class="pwa-install-banner" id="pwaInstallBanner">
    <div class="pwa-install-text">
        <strong>Ù…Ø³Ù†Ø¬Ø± Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯</strong>
        <span>Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ùˆ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ØŒ Ø§Ù¾ Ø±Ø§ Ø±ÙˆÛŒ ØµÙØ­Ù‡Ù” Ø§ØµÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</span>
    </div>
    <div class="pwa-install-actions">
        <button type="button" class="btn" id="pwaInstallBtn">Ù†ØµØ¨</button>
        <button type="button" class="pwa-dismiss" id="pwaInstallDismiss" aria-label="Ø¨Ø³ØªÙ†">Ã—</button>
    </div>
</div>
<div class="toast" id="toast" role="alert"></div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tweet-nacl@1.0.3/nacl.min.js"></script>
<script>
const userId = {{ user_id | default(0) }};
const username = {{ username | tojson }};
const csrfToken = {{ csrf_token | tojson }};
const initialGroupId = {{ initial_group_id | default(0) or 0 }};
const joinError = {% if join_error %}{{ join_error | tojson }}{% else %}null{% endif %};

const backBtn = document.getElementById('backBtn');
const headerTitle = document.getElementById('chatHeaderTitle');
const headerActions = document.getElementById('headerActions');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const drawerOverlay = document.getElementById('drawerOverlay');
const drawerUsername = document.getElementById('drawerUsername');
const drawerOpenChat = document.getElementById('drawerOpenChat');
const drawerOpenError = document.getElementById('drawerOpenError');
const drawerSettings = document.getElementById('drawerSettings');
const drawerConversations = document.getElementById('drawerConversations');
const settingsPanel = document.getElementById('settingsPanel');
const btnNotifySettings = document.getElementById('btnNotifySettings');
const chatSearchToggle = document.getElementById('chatSearchToggle');
const chatSearchInChat = document.getElementById('chatSearchInChat');
const chatSearchInput = document.getElementById('chatSearchInput');
const chatClearChatBtn = document.getElementById('chatClearChatBtn');
const chatPlaceholder = document.getElementById('chatPlaceholder');
const pwaInstallBanner = document.getElementById('pwaInstallBanner');
const pwaInstallBtn = document.getElementById('pwaInstallBtn');
const pwaInstallDismiss = document.getElementById('pwaInstallDismiss');
const chatActive = document.getElementById('chatActive');
const chatHeader = document.getElementById('chatHeader');
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const msgInput = document.getElementById('msgInput');
const btnAttach = document.getElementById('btnAttach');
const fileInput = document.getElementById('fileInput');
const attachmentStrip = document.getElementById('attachmentStrip');
const attachmentThumb = document.getElementById('attachmentThumb');
const attachmentFileIcon = document.getElementById('attachmentFileIcon');
const attachmentName = document.getElementById('attachmentName');
const attachmentRemove = document.getElementById('attachmentRemove');
const btnSend = document.getElementById('btnSend');
const btnVoice = document.getElementById('btnVoice');
var attachmentThumbUrl = null;
function clearAttachmentStrip() {
    selectedFile = null;
    if (fileInput) fileInput.value = '';
    if (attachmentName) attachmentName.textContent = '';
    if (attachmentThumb) {
        if (attachmentThumbUrl) { URL.revokeObjectURL(attachmentThumbUrl); attachmentThumbUrl = null; }
        attachmentThumb.removeAttribute('src');
        attachmentThumb.style.display = 'none';
    }
    if (attachmentFileIcon) attachmentFileIcon.style.display = '';
    if (attachmentStrip) attachmentStrip.classList.remove('visible');
}
const voicePreview = document.getElementById('voicePreview');
const voicePreviewAudio = document.getElementById('voicePreviewAudio');
const voicePreviewPlayBtn = document.getElementById('voicePreviewPlayBtn');
const voicePreviewProgress = document.getElementById('voicePreviewProgress');
const voicePreviewDuration = document.getElementById('voicePreviewDuration');
const btnSendVoice = document.getElementById('btnSendVoice');
const btnCancelVoice = document.getElementById('btnCancelVoice');
const voiceRecording = document.getElementById('voiceRecording');
const voiceRecordingTime = document.getElementById('voiceRecordingTime');
const btnStopVoice = document.getElementById('btnStopVoice');
const btnCancelRecording = document.getElementById('btnCancelRecording');
const micPermissionCard = document.getElementById('micPermissionCard');
const micPermissionDesc = document.getElementById('micPermissionDesc');
const btnGrantMic = document.getElementById('btnGrantMic');
const toastEl = document.getElementById('toast');
const historyList = document.getElementById('historyList');
const historyEmpty = document.getElementById('historyEmpty');
const convoSearch = document.getElementById('convoSearch');
const convoSearchBtn = document.getElementById('convoSearchBtn');
const chatHeaderTitle = document.getElementById('chatHeaderTitle');
const chatHeaderActions1 = document.getElementById('chatHeaderActions1');
const chatHeaderActionsGroup = document.getElementById('chatHeaderActionsGroup');
const groupInviteLinkBtn = document.getElementById('groupInviteLinkBtn');
const groupLeaveBtn = document.getElementById('groupLeaveBtn');
const blockBtn = document.getElementById('blockBtn');
const btnNotify = document.getElementById('btnNotify');
const groupsList = document.getElementById('groupsList');
const drawerNewGroupBtn = document.getElementById('drawerNewGroupBtn');
const drawerCreateGroupForm = document.getElementById('drawerCreateGroupForm');
const drawerGroupName = document.getElementById('drawerGroupName');
const drawerCreateGroupSubmit = document.getElementById('drawerCreateGroupSubmit');
const drawerGroupError = document.getElementById('drawerGroupError');
const drawerInviteResult = document.getElementById('drawerInviteResult');
const drawerInviteLink = document.getElementById('drawerInviteLink');
const drawerCopyInviteLink = document.getElementById('drawerCopyInviteLink');
const drawerOpenGroupAfterCreate = document.getElementById('drawerOpenGroupAfterCreate');
const drawerJoinCode = document.getElementById('drawerJoinCode');
const drawerJoinGroupBtn = document.getElementById('drawerJoinGroupBtn');
const drawerJoinError = document.getElementById('drawerJoinError');
const themeDark = document.getElementById('themeDark');
const themeLight = document.getElementById('themeLight');
const metaThemeColor = document.getElementById('metaThemeColor');

function applyTheme(theme) {
    var isLight = theme === 'light';
    document.documentElement.classList.toggle('theme-light', isLight);
    if (metaThemeColor) metaThemeColor.setAttribute('content', isLight ? '#f1f5f9' : '#0f172a');
    if (themeDark) themeDark.classList.toggle('active', !isLight);
    if (themeLight) themeLight.classList.toggle('active', isLight);
}
function initTheme() {
    var t = localStorage.getItem('theme') || 'dark';
    applyTheme(t);
}
if (themeDark) themeDark.addEventListener('click', function() { localStorage.setItem('theme', 'dark'); applyTheme('dark'); });
if (themeLight) themeLight.addEventListener('click', function() { localStorage.setItem('theme', 'light'); applyTheme('light'); });
initTheme();

var viewMode = 'list';
let currentOtherId = null;

// â€”â€”â€” E2EE (Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø§Ù†ØªÙ‡Ø§â€‘Ø¨Ù‡â€‘Ø§Ù†ØªÙ‡Ø§ Ù…Ø«Ù„ ØªÙ„Ú¯Ø±Ø§Ù…) â€”â€”â€”
var otherPublicKeyByUserId = {};
function b64ToUint8(b64) {
    try {
        var binary = atob(b64.replace(/\s/g, ''));
        var u8 = new Uint8Array(binary.length);
        for (var i = 0; i < binary.length; i++) u8[i] = binary.charCodeAt(i);
        return u8;
    } catch (e) { return null; }
}
function uint8ToB64(u8) {
    var binary = '';
    for (var i = 0; i < u8.length; i++) binary += String.fromCharCode(u8[i]);
    return btoa(binary);
}
function getE2EEKeyPair() {
    if (typeof nacl === 'undefined') return null;
    try {
        var pk = sessionStorage.getItem('e2ee_public');
        var sk = sessionStorage.getItem('e2ee_secret');
        if (pk && sk) {
            var pub = b64ToUint8(pk);
            var sec = b64ToUint8(sk);
            if (pub && pub.length === 32 && sec && sec.length === 32)
                return { publicKey: pub, secretKey: sec };
        }
        var kp = nacl.box.keyPair();
        sessionStorage.setItem('e2ee_public', uint8ToB64(kp.publicKey));
        sessionStorage.setItem('e2ee_secret', uint8ToB64(kp.secretKey));
        return kp;
    } catch (e) { return null; }
}
function uploadE2EEPublicKey() {
    var kp = getE2EEKeyPair();
    if (!kp) return;
    fetch('/api/me/keys', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ public_key: uint8ToB64(kp.publicKey) })
    }).catch(function() {});
}
function fetchOtherPublicKey(otherId, cb) {
    if (otherPublicKeyByUserId[otherId]) { if (cb) cb(otherPublicKeyByUserId[otherId]); return; }
    fetch('/api/keys/' + otherId).then(function(r) {
        if (!r.ok) { if (cb) cb(null); return; }
        return r.json();
    }).then(function(data) {
        if (data && data.public_key) {
            var u8 = b64ToUint8(data.public_key);
            if (u8 && u8.length === 32) { otherPublicKeyByUserId[otherId] = u8; if (cb) cb(u8); return; }
        }
        if (cb) cb(null);
    }).catch(function() { if (cb) cb(null); });
}
function decryptE2eeBody(bodyE2eeB64, senderPublicKeyB64) {
    if (typeof nacl === 'undefined' || !bodyE2eeB64) return null;
    var kp = getE2EEKeyPair();
    if (!kp) return null;
    var data = b64ToUint8(bodyE2eeB64);
    if (!data || data.length < 24 + 16) return null;
    var nonce = data.slice(0, 24);
    var box = data.slice(24);
    var senderPub = b64ToUint8(senderPublicKeyB64);
    if (!senderPub || senderPub.length !== 32) return null;
    try {
        var out = nacl.box.open(box, nonce, senderPub, kp.secretKey);
        return out ? new TextDecoder().decode(out) : null;
    } catch (e) { return null; }
}
function encryptE2eeBody(plaintext, recipientPublicKey) {
    if (typeof nacl === 'undefined' || !recipientPublicKey) return null;
    var kp = getE2EEKeyPair();
    if (!kp) return null;
    var nonce = nacl.randomBytes(24);
    var msg = new TextEncoder().encode(plaintext);
    var box = nacl.box(msg, nonce, recipientPublicKey, kp.secretKey);
    var combined = new Uint8Array(24 + box.length);
    combined.set(nonce, 0);
    combined.set(box, 24);
    return uint8ToB64(combined);
}
function prepareE2eeMessages(messages, publicKeys) {
    if (!messages || !publicKeys) return messages;
    for (var i = 0; i < messages.length; i++) {
        var m = messages[i];
        if (!m.is_e2ee || !m.body_e2ee) continue;
        if (m.sender_id === userId) {
            m.body = '[Ù¾ÛŒØ§Ù… Ø´Ù…Ø§]';
            continue;
        }
        var senderPub = publicKeys[m.sender_id];
        if (!senderPub) { m.body = '[Ù¾ÛŒØ§Ù… Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ â€” Ú©Ù„ÛŒØ¯ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª]'; continue; }
        var dec = decryptE2eeBody(m.body_e2ee, senderPub);
        m.body = dec != null ? dec : '[Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯]';
    }
    return messages;
}
let currentOtherName = null;
let currentGroupId = null;
let currentGroupName = null;
let currentGroupInviteCode = null;
let selectedFile = null;
let iBlockedThem = false;
let isVoiceRecording = false;
let voiceBlob = null;
let voiceChunks = [];
let mediaRecorderInstance = null;
let voiceStream = null;
let voiceRecordingTimer = null;
let voiceRecordingCancelled = false;
var chatPollInterval = null;
const MIC_PERMISSION_KEY = 'mic_permission_requested';
var lastChatMessageCount = 0;
var lastChatLastId = 0;

function stopChatPoll() {
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
}

function startChatPoll() {
    if (chatPollInterval) return;
    chatPollInterval = setInterval(function() {
        if (viewMode === 'group' && currentGroupId) loadGroupChat(true);
        else if (currentOtherId) loadChat(true);
    }, 3500);
}

function showOpenError(msg) {
    if (drawerOpenError) drawerOpenError.textContent = msg || '';
}
function openDrawer() {
    if (drawerOverlay) drawerOverlay.classList.add('open');
}
function closeDrawer() {
    if (drawerOverlay) drawerOverlay.classList.remove('open');
}
var tgApp = document.getElementById('tgApp');
var tgSidebar = document.getElementById('tgSidebar');
var tgMain = document.getElementById('tgMain');
function showView(mode) {
    viewMode = mode;
    if (tgSidebar) tgSidebar.classList.toggle('hidden-mobile', mode === 'chat' || mode === 'group');
    if (tgMain) tgMain.classList.toggle('has-chat', mode === 'chat' || mode === 'group');
    if (chatPlaceholder) chatPlaceholder.style.display = (mode === 'list') ? 'flex' : 'none';
    if (chatActive) {
        if (mode === 'chat' || mode === 'group') {
            chatActive.classList.add('visible');
            chatActive.style.display = 'flex';
        } else {
            chatActive.classList.remove('visible');
            chatActive.style.display = 'none';
        }
    }
    if (settingsPanel) {
        if (mode === 'settings') {
            settingsPanel.classList.add('visible');
            settingsPanel.style.display = 'flex';
        } else {
            settingsPanel.classList.remove('visible');
            settingsPanel.style.display = 'none';
        }
    }
    if (backBtn) backBtn.classList.toggle('visible', mode === 'chat' || mode === 'settings' || mode === 'group');
    if (headerTitle) {
        if (mode === 'list') headerTitle.textContent = 'Ù…Ø³Ù†Ø¬Ø±';
        else if (mode === 'settings') headerTitle.textContent = 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª';
        else if (mode === 'chat' && currentOtherName) headerTitle.textContent = currentOtherName;
        else if (mode === 'group' && currentGroupName) headerTitle.textContent = currentGroupName;
    }
    var isChatOrGroup = (mode === 'chat' || mode === 'group');
    if (chatHeaderActions1) chatHeaderActions1.style.display = (mode === 'chat') ? 'flex' : 'none';
    if (chatHeaderActionsGroup) chatHeaderActionsGroup.style.display = (mode === 'group') ? 'flex' : 'none';
    if (chatSearchInChat) chatSearchInChat.classList.remove('visible');
}

function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(function() { toastEl.classList.remove('show'); }, 3000);
}

function setLoading(loading) {
    if (drawerOpenChat) {
        drawerOpenChat.disabled = loading;
        if (loading) drawerOpenChat.classList.add('loading');
        else drawerOpenChat.classList.remove('loading');
    }
}

function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

if (btnAttach) btnAttach.addEventListener('click', function() { if (fileInput) fileInput.click(); });
if (fileInput) {
    fileInput.addEventListener('change', function() {
        selectedFile = this.files[0] || null;
        if (!selectedFile) {
            clearAttachmentStrip();
            return;
        }
        if (attachmentName) attachmentName.textContent = selectedFile.name;
        var isImage = selectedFile.type.indexOf('image/') === 0;
        if (attachmentThumb) {
            if (attachmentThumbUrl) { URL.revokeObjectURL(attachmentThumbUrl); attachmentThumbUrl = null; }
            if (isImage) {
                attachmentThumbUrl = URL.createObjectURL(selectedFile);
                attachmentThumb.src = attachmentThumbUrl;
                attachmentThumb.style.display = 'block';
                if (attachmentFileIcon) attachmentFileIcon.style.display = 'none';
            } else {
                attachmentThumb.removeAttribute('src');
                attachmentThumb.style.display = 'none';
                if (attachmentFileIcon) attachmentFileIcon.style.display = 'inline-flex';
            }
        }
        if (attachmentStrip) attachmentStrip.classList.add('visible');
    });
}
if (attachmentRemove) attachmentRemove.addEventListener('click', clearAttachmentStrip);

function formatVoiceTime(sec) {
    if (sec === undefined || isNaN(sec)) return '0:00';
    var m = Math.floor(sec / 60);
    var s = Math.floor(sec % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
}
function hideVoicePreview() {
    if (voiceRecordingTimer) {
        clearInterval(voiceRecordingTimer);
        voiceRecordingTimer = null;
    }
    if (voicePreviewAudio && voicePreviewAudio.src && voicePreviewAudio.src.indexOf('blob:') === 0) {
        URL.revokeObjectURL(voicePreviewAudio.src);
    }
    voicePreviewAudio.removeEventListener('timeupdate', _voicePreviewTimeUpdate);
    voicePreviewAudio.removeEventListener('ended', _voicePreviewEnded);
    voiceBlob = null;
    if (voicePreview) voicePreview.style.display = 'none';
    if (voicePreviewAudio) { voicePreviewAudio.pause(); voicePreviewAudio.src = ''; voicePreviewAudio.srcObject = null; }
    if (voicePreviewPlayBtn) { voicePreviewPlayBtn.textContent = 'â–¶'; voicePreviewPlayBtn.classList.remove('playing'); }
    if (btnVoice) btnVoice.classList.remove('recording');
    if (chatForm) chatForm.classList.remove('voice-mode');
}
function _voicePreviewTimeUpdate() {
    var a = voicePreviewAudio;
    if (voicePreviewProgress && a.duration) voicePreviewProgress.style.width = (100 * a.currentTime / a.duration) + '%';
}
function _voicePreviewEnded() {
    if (voicePreviewPlayBtn) { voicePreviewPlayBtn.textContent = 'â–¶'; voicePreviewPlayBtn.classList.remove('playing'); }
    if (voicePreviewProgress) voicePreviewProgress.style.width = '0%';
}
function showVoicePreview(blob) {
    voiceBlob = blob;
    if (voiceRecording) voiceRecording.style.display = 'none';
    isVoiceRecording = false;
    if (btnVoice) btnVoice.classList.remove('recording');
    if (voiceRecordingTimer) { clearInterval(voiceRecordingTimer); voiceRecordingTimer = null; }
    if (voicePreviewAudio && blob) {
        voicePreviewAudio.src = URL.createObjectURL(blob);
        voicePreviewProgress.style.width = '0%';
        voicePreviewDuration.textContent = '0:00';
        voicePreviewPlayBtn.textContent = 'â–¶';
        voicePreviewPlayBtn.classList.remove('playing');
        voicePreviewAudio.addEventListener('loadedmetadata', function onMeta() {
            voicePreviewDuration.textContent = formatVoiceTime(voicePreviewAudio.duration);
        }, { once: true });
        voicePreviewAudio.addEventListener('timeupdate', _voicePreviewTimeUpdate);
        voicePreviewAudio.addEventListener('ended', _voicePreviewEnded);
        voicePreview.style.display = 'flex';
        if (chatForm) chatForm.classList.add('voice-mode');
    }
}
function startVoiceRecording() {
    if (!window.isSecureContext) {
        showToast('Ø¶Ø¨Ø· ÙˆÛŒØ³ ÙÙ‚Ø· Ø¨Ø§ https ÛŒØ§ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ Ù…Ù…Ú©Ù† Ø§Ø³Øª. Ø³Ø§ÛŒØª Ø±Ø§ Ø¨Ø§ https Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Â«Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡Ù” Ø§ØµÙ„ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
        return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
        return;
    }
    if (!currentOtherId) {
        showToast('Ø§ÙˆÙ„ ÛŒÚ© Ú†Øª Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯');
        return;
    }
    if (iBlockedThem) {
        showToast('Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª');
        return;
    }
    voiceChunks = [];
    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        voiceStream = stream;
        var mime = 'audio/webm';
        if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime = 'audio/webm;codecs=opus';
        else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) mime = 'audio/ogg;codecs=opus';
        mediaRecorderInstance = new MediaRecorder(stream);
        mediaRecorderInstance.ondataavailable = function(e) { if (e.data && e.data.size > 0) voiceChunks.push(e.data); };
        mediaRecorderInstance.onstop = function() {
            voiceStream.getTracks().forEach(function(t) { t.stop(); });
            voiceStream = null;
            if (voiceRecordingCancelled) {
                voiceRecordingCancelled = false;
                return;
            }
            if (voiceChunks.length) {
                var blob = new Blob(voiceChunks, { type: mime });
                showVoicePreview(blob);
            } else {
                showToast('Ø¶Ø¨Ø· Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
            }
        };
        mediaRecorderInstance.start(200);
        isVoiceRecording = true;
        if (voiceRecording) {
            voiceRecording.style.display = 'flex';
            voiceRecordingTime.textContent = '0:00';
        }
        if (chatForm) chatForm.classList.add('voice-mode');
        if (btnVoice) btnVoice.classList.add('recording');
        var startMs = Date.now();
        voiceRecordingTimer = setInterval(function() {
            var sec = Math.floor((Date.now() - startMs) / 1000);
            if (voiceRecordingTime) voiceRecordingTime.textContent = formatVoiceTime(sec);
        }, 1000);
    }).catch(function(err) {
        if (err && err.name === 'NotAllowedError') {
            showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø§ÛŒØª/Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯.');
        } else {
            showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ø¨Ø§ https ÛŒØ§ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.');
        }
    });
}
function stopVoiceRecording() {
    if (!isVoiceRecording || !mediaRecorderInstance || mediaRecorderInstance.state === 'inactive') return;
    if (voiceRecordingTimer) { clearInterval(voiceRecordingTimer); voiceRecordingTimer = null; }
    mediaRecorderInstance.stop();
    mediaRecorderInstance = null;
}
function cancelVoiceRecording() {
    if (!isVoiceRecording || !mediaRecorderInstance) return;
    voiceRecordingCancelled = true;
    if (voiceRecordingTimer) { clearInterval(voiceRecordingTimer); voiceRecordingTimer = null; }
    mediaRecorderInstance.stop();
    mediaRecorderInstance = null;
    voiceChunks = [];
    isVoiceRecording = false;
    if (voiceRecording) voiceRecording.style.display = 'none';
    if (btnVoice) btnVoice.classList.remove('recording');
    if (chatForm) chatForm.classList.remove('voice-mode');
    showToast('Ø¶Ø¨Ø· Ù„ØºÙˆ Ø´Ø¯');
}

if (btnVoice) {
    btnVoice.addEventListener('click', function() {
        if (voiceBlob) { hideVoicePreview(); return; }
        if (isVoiceRecording) { stopVoiceRecording(); return; }
        startVoiceRecording();
    });
}
if (btnStopVoice) {
    btnStopVoice.addEventListener('click', stopVoiceRecording);
}
if (btnCancelRecording) {
    btnCancelRecording.addEventListener('click', cancelVoiceRecording);
}
if (voicePreviewPlayBtn && voicePreviewAudio) {
    voicePreviewPlayBtn.addEventListener('click', function() {
        if (voicePreviewAudio.paused) {
            voicePreviewAudio.play();
            voicePreviewPlayBtn.textContent = 'âšâš';
            voicePreviewPlayBtn.classList.add('playing');
        } else {
            voicePreviewAudio.pause();
            voicePreviewPlayBtn.textContent = 'â–¶';
            voicePreviewPlayBtn.classList.remove('playing');
        }
    });
}
if (btnSendVoice) {
    btnSendVoice.addEventListener('click', async function() {
        if (!voiceBlob) return;
        var fd = new FormData();
        fd.append('file', voiceBlob, 'voice.webm');
        fd.append('message_type', 'voice');
        fd.append('csrf_token', csrfToken);
        btnSendVoice.disabled = true;
        var url = currentGroupId ? ('/api/groups/' + currentGroupId + '/send') : '/api/send';
        if (!currentGroupId) fd.append('receiver_id', currentOtherId);
        try {
            var r = await fetch(url, { method: 'POST', body: fd });
            var res = await r.json();
            if (res.ok) {
                hideVoicePreview();
                if (currentGroupId) loadGroupChat(); else loadChat();
                showToast('ÙˆÛŒØ³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            } else {
                showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³');
            }
        } finally {
            btnSendVoice.disabled = false;
        }
    });
}
if (btnCancelVoice) {
    btnCancelVoice.addEventListener('click', hideVoicePreview);
}

function updateMicPermissionCard() {
    if (!micPermissionCard || !chatActive) return;
    var hasRequested = localStorage.getItem(MIC_PERMISSION_KEY) === '1';
    var chatOpen = chatActive.classList.contains('visible') && (currentOtherId || currentGroupId);
    if (!chatOpen || hasRequested) {
        micPermissionCard.style.display = 'none';
        return;
    }
    if (!window.isSecureContext) {
        micPermissionCard.className = 'mic-permission-card insecure';
        if (micPermissionDesc) micPermissionDesc.textContent = 'Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ÙˆÛŒØ³ØŒ Ø³Ø§ÛŒØª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ https Ø¨Ø§Ø² Ø´ÙˆØ¯ ÛŒØ§ ÙˆØ¨â€ŒØ§Ù¾ Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯.';
        if (btnGrantMic) { btnGrantMic.textContent = 'Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…'; btnGrantMic.dataset.action = 'dismiss'; }
    } else {
        micPermissionCard.className = 'mic-permission-card';
        if (micPermissionDesc) micPermissionDesc.textContent = 'Ø§Ø¬Ø§Ø²Ù‡Ù” Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ³ Ø¶Ø¨Ø· Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.';
        if (btnGrantMic) { btnGrantMic.textContent = 'Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†'; btnGrantMic.dataset.action = 'grant'; }
    }
    micPermissionCard.style.display = 'flex';
}
if (btnGrantMic) {
    btnGrantMic.addEventListener('click', function() {
        if (btnGrantMic.dataset.action === 'dismiss') {
            localStorage.setItem(MIC_PERMISSION_KEY, '1');
            micPermissionCard.style.display = 'none';
            return;
        }
        if (!window.isSecureContext) {
            showToast('Ø¶Ø¨Ø· ÙˆÛŒØ³ ÙÙ‚Ø· Ø¨Ø§ https ÛŒØ§ Ù†ØµØ¨ ÙˆØ¨â€ŒØ§Ù¾ Ù…Ù…Ú©Ù† Ø§Ø³Øª.');
            return;
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showToast('Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
            return;
        }
        navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
            stream.getTracks().forEach(function(t) { t.stop(); });
            localStorage.setItem(MIC_PERMISSION_KEY, '1');
            micPermissionCard.style.display = 'none';
            showToast('Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† ÙØ¹Ø§Ù„ Ø´Ø¯. Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ ÙˆÛŒØ³ Ø¨ÙØ±Ø³ØªÛŒØ¯.');
        }).catch(function(err) {
            if (err && err.name === 'NotAllowedError') {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡Ù” Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯.');
            } else {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.');
            }
            localStorage.setItem(MIC_PERMISSION_KEY, '1');
            micPermissionCard.style.display = 'none';
        });
    });
}

function loadConversations(q) {
    var url = '/api/conversations';
    if (q) url += '?q=' + encodeURIComponent(q);
    fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(list) {
            if (!Array.isArray(list) || list.length === 0) {
                historyList.innerHTML = '';
                historyEmpty.style.display = 'block';
                historyEmpty.textContent = q ? 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.' : 'Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù Ø±Ø§ Ù¾Ø§ÛŒÛŒÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.';
                return;
            }
            historyEmpty.style.display = 'none';
            historyList.innerHTML = list.map(function(c, i) {
                var rawName = (c.other_username != null) ? String(c.other_username) : '';
                var safeName = escapeHtml(rawName);
                var safePreview = escapeHtml(c.last_preview || '');
                var safeTime = escapeHtml(c.last_at || '');
                var isActive = (c.other_id === currentOtherId);
                var initial = rawName.charAt(0).toUpperCase() || '?';
                var shortTime = (c.last_at || '').toString().trim();
                if (shortTime.length > 16) shortTime = shortTime.slice(11, 16);
                return '<li class="history-item' + (isActive ? ' active' : '') + '" data-id="' + c.other_id + '" data-name="' + safeName + '">' +
                    '<div class="h-avatar">' + escapeHtml(initial) + '</div>' +
                    '<div class="h-body">' +
                    '<div class="h-top"><span class="h-username">' + safeName + '</span><span class="h-time">' + escapeHtml(shortTime) + '</span></div>' +
                    '<div class="h-preview">' + safePreview + '</div></div>' +
                    '<button type="button" class="h-delete" data-id="' + c.other_id + '" title="Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ">ğŸ—‘</button></li>';
            }).join('');
            historyList.querySelectorAll('.history-item').forEach(function(el) {
                var id = parseInt(el.getAttribute('data-id'), 10);
                var name = el.getAttribute('data-name') || '';
                el.querySelector('.h-delete').addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!confirm('Ù‡Ù…Ù‡Ù” Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ (Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ø·Ø±Ù)')) return;
                    fetch('/api/conversation/' + id + '/clear', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                        body: JSON.stringify({ csrf_token: csrfToken })
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        if (res.ok) {
                            if (currentOtherId === id) {
                                currentOtherId = null;
                                currentOtherName = null;
                                showView('list');
                            }
                            loadConversations();
                            showToast('Ú¯ÙØªÚ¯Ùˆ Ø­Ø°Ù Ø´Ø¯');
                        } else { showToast(res.error || 'Ø®Ø·Ø§'); }
                    });
                });
                el.addEventListener('click', function(e) {
                    if (e.target.closest('.h-delete')) return;
                    currentGroupId = null;
                    currentGroupName = null;
                    currentGroupInviteCode = null;
                    currentOtherId = id;
                    currentOtherName = name;
                    lastChatMessageCount = 0;
                    lastChatLastId = 0;
                    showView('chat');
                    if (chatHeaderTitle) chatHeaderTitle.textContent = name;
                    loadChat();
                    updateMicPermissionCard();
                });
            });
        })
        .catch(function() {
            historyList.innerHTML = '';
            historyEmpty.style.display = 'block';
            historyEmpty.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
        });
}

function loadGroupsList() {
    if (!groupsList) return;
    fetch('/api/groups')
        .then(function(r) { return r.json(); })
        .then(function(list) {
            if (!Array.isArray(list) || list.length === 0) {
                groupsList.innerHTML = '';
                return;
            }
            groupsList.innerHTML = list.map(function(g) {
                var name = escapeHtml(g.name || 'Ú¯Ø±ÙˆÙ‡');
                var preview = escapeHtml(g.last_preview || '');
                var initial = (g.name || 'Ú¯').charAt(0).toUpperCase();
                var code = (g.invite_code || '');
                return '<li class="history-item" data-group-id="' + g.id + '" data-group-name="' + name + '" data-invite-code="' + escapeHtml(code) + '" style="animation-delay: 0s">' +
                    '<div class="h-avatar">' + initial + '</div>' +
                    '<div class="h-body"><div class="h-username">' + name + '</div><div class="h-preview">' + preview + '</div></div></li>';
            }).join('');
            groupsList.querySelectorAll('.history-item').forEach(function(el) {
                var gid = parseInt(el.getAttribute('data-group-id'), 10);
                var gname = el.getAttribute('data-group-name') || '';
                var code = el.getAttribute('data-invite-code') || '';
                el.addEventListener('click', function() {
                    currentGroupId = gid;
                    currentGroupName = gname;
                    currentGroupInviteCode = code;
                    currentOtherId = null;
                    currentOtherName = null;
                    closeDrawer();
                    showView('group');
                    if (chatHeaderTitle) chatHeaderTitle.textContent = gname;
                    loadGroupChat();
                    updateMicPermissionCard();
                });
            });
        })
        .catch(function() { groupsList.innerHTML = ''; });
}

function buildGroupMessageHtml(m, senders) {
    var sent = m.sender_id === userId;
    var cls = sent ? 'sent' : 'received';
    var senderName = (senders && senders[m.sender_id]) ? senders[m.sender_id] : ('Ú©Ø§Ø±Ø¨Ø± ' + m.sender_id);
    var parts = [];
    if (sent && m.id) {
        parts.push('<button type="button" class="msg-del btn btn-ghost" data-msg-id="' + m.id + '" title="Ø­Ø°Ù Ù¾ÛŒØ§Ù…">Ã—</button>');
    }
    if (!sent) parts.push('<span class="msg-sender-name">' + escapeHtml(senderName) + '</span>');
    if (m.message_type === 'image' && m.id) {
        parts.push('<img class="msg-img" src="/api/group-file/' + m.id + '" alt="Ø¹Ú©Ø³" loading="lazy">');
    }
    if (m.message_type === 'voice' && m.id) {
        var bars = [];
        for (var i = 0; i < 20; i++) bars.push('<span style="height:' + (30 + (m.id + i) % 70) + '%" data-idx="' + i + '"></span>');
        parts.push('<div class="voice-msg-bubble" data-msg-id="' + m.id + '">' +
            '<button type="button" class="voice-play-btn" aria-label="Ù¾Ø®Ø´">â–¶</button>' +
            '<div class="voice-waveform">' + bars.join('') + '</div>' +
            '<span class="voice-duration">0:00</span>' +
            '<audio preload="metadata" src="/api/group-file/' + m.id + '" data-msg-id="' + m.id + '"></audio></div>');
    }
    if (m.message_type === 'file' && m.id && m.file_name) {
        parts.push('<a class="msg-file" href="/api/group-file/' + m.id + '" download="' + escapeHtml(m.file_name) + '">' + escapeHtml(m.file_name) + '</a>');
    }
    if (m.body) parts.push(escapeHtml(m.body));
    if (parts.length === 0) parts.push('[Ù¾ÛŒØ§Ù…]');
    var timeStr = (m.created_at || '').toString().trim();
    if (timeStr.length > 16) timeStr = timeStr.slice(11, 16);
    parts.push('<div class="msg-meta"><time>' + escapeHtml(timeStr) + '</time></div>');
    return '<div class="msg ' + cls + '" data-msg-id="' + (m.id || '') + '">' + parts.join('') + '</div>';
}
function buildGroupMessagesWithDateSep(messages, senders) {
    var out = [];
    var lastDate = '';
    for (var i = 0; i < messages.length; i++) {
        var m = messages[i];
        var dateKey = (m.created_at || '').toString().trim().slice(0, 10);
        if (dateKey && dateKey !== lastDate) {
            lastDate = dateKey;
            out.push('<div class="msg-date-sep"><span>' + escapeHtml(formatDateSep(dateKey)) + '</span></div>');
        }
        out.push(buildGroupMessageHtml(m, senders));
    }
    return out.join('');
}

var lastGroupMessageCount = 0;
var lastGroupLastId = 0;
function loadGroupChat(isPolling) {
    if (!currentGroupId) return;
    var wasAtBottom = !isPolling || (chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 80);
    fetch('/api/groups/' + currentGroupId + '/messages')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                if (!isPolling) chatMessages.innerHTML = '<p class="error">' + escapeHtml(data.error) + '</p>';
                return;
            }
            var messages = data.messages || [];
            var senders = data.senders || {};
            var maxId = 0;
            messages.forEach(function(m) { if (m.id > maxId) maxId = m.id; });
            var sameContent = isPolling && messages.length === lastGroupMessageCount && maxId === lastGroupLastId;
            if (sameContent) return;
            lastGroupMessageCount = messages.length;
            lastGroupLastId = maxId;
            chatMessages.innerHTML = buildGroupMessagesWithDateSep(messages, senders);
            initVoiceBubbles();
            chatMessages.querySelectorAll('.msg-del').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var mid = parseInt(btn.getAttribute('data-msg-id'), 10);
                    if (mid !== mid) return;
                    fetch('/api/groups/' + currentGroupId + '/message/' + mid, {
                        method: 'DELETE',
                        headers: { 'X-CSRF-Token': csrfToken }
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        if (res.ok) {
                            var el = chatMessages.querySelector('.msg[data-msg-id="' + mid + '"]');
                            if (el) el.remove();
                        } else { showToast(res.error || 'Ø®Ø·Ø§'); }
                    });
                });
            });
            if (wasAtBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
            if (!isPolling) startChatPoll();
        });
}

if (convoSearch) {
    convoSearch.addEventListener('input', function() { loadConversations(convoSearch.value.trim()); });
    convoSearch.addEventListener('keydown', function(e) { if (e.key === 'Enter') loadConversations(convoSearch.value.trim()); });
}

backBtn.addEventListener('click', function() {
    if (viewMode === 'chat') {
        stopChatPoll();
        if (isVoiceRecording) stopVoiceRecording();
        hideVoicePreview();
        lastChatMessageCount = 0;
        lastChatLastId = 0;
        clearAttachmentStrip();
        showOpenError('');
    }
    if (viewMode === 'group') {
        stopChatPoll();
        currentGroupId = null;
        currentGroupName = null;
        currentGroupInviteCode = null;
        clearAttachmentStrip();
    }
    showView('list');
    loadConversations();
    loadGroupsList();
});

if (drawerOpenChat) {
    drawerOpenChat.addEventListener('click', async function() {
        var raw = (drawerUsername && drawerUsername.value) ? drawerUsername.value.trim() : '';
        showOpenError('');
        if (!raw) {
            showOpenError('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
            return;
        }
        setLoading(true);
        try {
            var r = await fetch('/api/user-by-username/' + encodeURIComponent(raw));
            var data = await r.json();
            if (r.status === 404 || r.status === 400 || data.error) {
                showOpenError(data.error || 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
                return;
            }
            currentOtherId = data.id;
            currentOtherName = data.username;
            lastChatMessageCount = 0;
            lastChatLastId = 0;
            closeDrawer();
            showView('chat');
            if (chatHeaderTitle) chatHeaderTitle.textContent = currentOtherName;
            loadChat();
            loadConversations();
            updateMicPermissionCard();
            if (drawerUsername) drawerUsername.value = '';
        } finally {
            setLoading(false);
        }
    });
}
if (hamburgerBtn) hamburgerBtn.addEventListener('click', openDrawer);
if (drawerOverlay) {
    drawerOverlay.addEventListener('click', function(e) {
        if (e.target === drawerOverlay) closeDrawer();
    });
}
if (drawerConversations) {
    drawerConversations.addEventListener('click', function() {
        closeDrawer();
        showView('list');
    });
}
if (drawerSettings) {
    drawerSettings.addEventListener('click', function() {
        closeDrawer();
        showView('settings');
        if (btnNotifySettings && typeof Notification !== 'undefined' && Notification.permission === 'granted') {
            btnNotifySettings.textContent = 'ÙØ¹Ø§Ù„';
        }
    });
}

if (drawerNewGroupBtn && drawerCreateGroupForm) {
    drawerNewGroupBtn.addEventListener('click', function() {
        drawerCreateGroupForm.style.display = drawerCreateGroupForm.style.display === 'none' ? 'block' : 'none';
        if (drawerGroupError) drawerGroupError.textContent = '';
        if (drawerInviteResult) drawerInviteResult.style.display = 'none';
    });
}
if (drawerCreateGroupSubmit && drawerGroupName) {
    drawerCreateGroupSubmit.addEventListener('click', async function() {
        var name = (drawerGroupName.value || '').trim();
        if (drawerGroupError) drawerGroupError.textContent = '';
        if (!name) { if (drawerGroupError) drawerGroupError.textContent = 'Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'; return; }
        drawerCreateGroupSubmit.disabled = true;
        try {
            var r = await fetch('/api/groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ name: name })
            });
            var res = await r.json();
            if (res.ok && res.group && res.invite_link) {
                if (drawerCreateGroupForm) drawerCreateGroupForm.style.display = 'none';
                if (drawerInviteResult) {
                    drawerInviteResult.style.display = 'block';
                    if (drawerInviteLink) drawerInviteLink.value = res.invite_link;
                    currentGroupId = res.group.id;
                    currentGroupName = res.group.name;
                    currentGroupInviteCode = res.group.invite_code;
                }
            } else {
                if (drawerGroupError) drawerGroupError.textContent = res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡';
            }
        } finally { drawerCreateGroupSubmit.disabled = false; }
    });
}
if (drawerCopyInviteLink && drawerInviteLink) {
    drawerCopyInviteLink.addEventListener('click', function() {
        drawerInviteLink.select();
        document.execCommand('copy');
        showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯');
    });
}
if (drawerOpenGroupAfterCreate) {
    drawerOpenGroupAfterCreate.addEventListener('click', function() {
        if (!currentGroupId) return;
        closeDrawer();
        showView('group');
        if (chatHeaderTitle) chatHeaderTitle.textContent = currentGroupName || 'Ú¯Ø±ÙˆÙ‡';
        drawerInviteResult.style.display = 'none';
        if (drawerGroupName) drawerGroupName.value = '';
        loadGroupChat();
        loadGroupsList();
        updateMicPermissionCard();
    });
}
if (drawerJoinGroupBtn && drawerJoinCode) {
    drawerJoinGroupBtn.addEventListener('click', async function() {
        var raw = (drawerJoinCode.value || '').trim();
        if (drawerJoinError) drawerJoinError.textContent = '';
        var code = raw.replace(/.*\/join\//i, '').split('?')[0].trim();
        if (!code) { if (drawerJoinError) drawerJoinError.textContent = 'Ú©Ø¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'; return; }
        drawerJoinGroupBtn.disabled = true;
        try {
            var r = await fetch('/api/groups/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ invite_code: code })
            });
            var res = await r.json();
            if (res.ok && res.group) {
                currentGroupId = res.group.id;
                currentGroupName = res.group.name;
                currentGroupInviteCode = res.group.invite_code;
                if (drawerJoinCode) drawerJoinCode.value = '';
                closeDrawer();
                showView('group');
                if (chatHeaderTitle) chatHeaderTitle.textContent = currentGroupName;
                loadGroupChat();
                loadGroupsList();
                updateMicPermissionCard();
                showToast('Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒÙˆØ³ØªÛŒØ¯');
            } else {
                if (drawerJoinError) drawerJoinError.textContent = res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¹Ø¶ÙˆÛŒØª';
            }
        } finally { drawerJoinGroupBtn.disabled = false; }
    });
}

if (groupInviteLinkBtn) {
    groupInviteLinkBtn.addEventListener('click', function() {
        if (!currentGroupId) return;
        if (currentGroupInviteCode) {
            var link = window.location.origin + '/join/' + currentGroupInviteCode;
            navigator.clipboard.writeText(link).then(function() { showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯'); }).catch(function() {
                var inp = document.createElement('input');
                inp.value = link;
                document.body.appendChild(inp);
                inp.select();
                document.execCommand('copy');
                document.body.removeChild(inp);
                showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯');
            });
            return;
        }
        fetch('/api/groups/' + currentGroupId).then(function(r) { return r.json(); }).then(function(g) {
            if (g && g.invite_code) {
                currentGroupInviteCode = g.invite_code;
                var link = window.location.origin + '/join/' + g.invite_code;
                navigator.clipboard.writeText(link).then(function() { showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯'); }).catch(function() {
                    var inp = document.createElement('input');
                    inp.value = link;
                    document.body.appendChild(inp);
                    inp.select();
                    document.execCommand('copy');
                    document.body.removeChild(inp);
                    showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯');
                });
            } else { showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú©'); }
        });
    });
}
if (groupLeaveBtn) {
    groupLeaveBtn.addEventListener('click', function() {
        if (!currentGroupId) return;
        if (!confirm('Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) return;
        fetch('/api/groups/' + currentGroupId + '/leave', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({})
        }).then(function(r) { return r.json(); }).then(function(res) {
            if (res.ok) {
                stopChatPoll();
                currentGroupId = null;
                currentGroupName = null;
                currentGroupInviteCode = null;
                showView('list');
                loadGroupsList();
                loadConversations();
                showToast('Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯');
            } else { showToast(res.error || 'Ø®Ø·Ø§'); }
        });
    });
}
if (btnNotifySettings) {
    btnNotifySettings.addEventListener('click', function() {
        if (typeof Notification === 'undefined') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
            return;
        }
        if (Notification.permission === 'granted') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª');
            return;
        }
        Notification.requestPermission().then(function(p) {
            if (p === 'granted') { showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯'); btnNotifySettings.textContent = 'ÙØ¹Ø§Ù„'; }
            else if (p === 'denied') showToast('Ø§Ø¬Ø§Ø²Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯');
        });
    });
}

function initVoiceBubbles() {
    if (!chatMessages) return;
    chatMessages.querySelectorAll('.voice-msg-bubble').forEach(function(bubble) {
        var btn = bubble.querySelector('.voice-play-btn');
        var durEl = bubble.querySelector('.voice-duration');
        var audio = bubble.querySelector('audio');
        var waveform = bubble.querySelector('.voice-waveform');
        if (!btn || !audio) return;
        audio.addEventListener('loadedmetadata', function() {
            if (durEl) durEl.textContent = formatVoiceTime(audio.duration);
        });
        audio.addEventListener('ended', function() {
            if (btn) { btn.textContent = 'â–¶'; btn.classList.remove('playing'); }
            if (waveform) waveform.querySelectorAll('span').forEach(function(s) { s.classList.remove('active'); });
        });
        audio.addEventListener('timeupdate', function() {
            if (!waveform || !audio.duration) return;
            var pct = audio.currentTime / audio.duration;
            var idx = Math.floor(pct * 20);
            waveform.querySelectorAll('span').forEach(function(s, i) {
                if (i <= idx) s.classList.add('active'); else s.classList.remove('active');
            });
        });
        btn.addEventListener('click', function() {
            if (audio.paused) {
                audio.play();
                btn.textContent = 'âšâš';
                btn.classList.add('playing');
            } else {
                audio.pause();
                btn.textContent = 'â–¶';
                btn.classList.remove('playing');
            }
        });
    });
}

function buildMessageHtml(m, otherReadUpTo) {
    var sent = m.sender_id === userId;
    var cls = sent ? 'sent' : 'received';
    var parts = [];
    if (sent && m.id) {
        parts.push('<button type="button" class="msg-del btn btn-ghost" data-msg-id="' + m.id + '" title="Ø­Ø°Ù Ù¾ÛŒØ§Ù…">Ã—</button>');
    }
    if (m.message_type === 'image' && m.id) {
        parts.push('<img class="msg-img" src="/api/file/' + m.id + '" alt="Ø¹Ú©Ø³" loading="lazy">');
    }
    if (m.message_type === 'voice' && m.id) {
        var waveId = 'w' + m.id;
        var bars = [];
        for (var i = 0; i < 20; i++) {
            var h = (30 + (m.id + i) % 70) + '%';
            bars.push('<span style="height:' + h + '" data-idx="' + i + '"></span>');
        }
        parts.push(
            '<div class="voice-msg-bubble" data-msg-id="' + m.id + '">' +
            '<button type="button" class="voice-play-btn" aria-label="Ù¾Ø®Ø´">â–¶</button>' +
            '<div class="voice-waveform" id="' + waveId + '">' + bars.join('') + '</div>' +
            '<span class="voice-duration">0:00</span>' +
            '<audio preload="metadata" src="/api/file/' + m.id + '" data-msg-id="' + m.id + '"></audio>' +
            '</div>'
        );
    }
    if (m.message_type === 'file' && m.id && m.file_name) {
        parts.push('<a class="msg-file" href="/api/file/' + m.id + '" download="' + escapeHtml(m.file_name) + '">' + escapeHtml(m.file_name) + '</a>');
    }
    if (m.body) {
        parts.push(escapeHtml(m.body));
    }
    if (parts.length === 0) {
        parts.push('[Ù¾ÛŒØ§Ù…]');
    }
    var timeStr = (m.created_at || '').toString().trim();
    if (timeStr.length > 16) timeStr = timeStr.slice(11, 16);
    var meta = '<div class="msg-meta"><time>' + escapeHtml(timeStr) + '</time>';
    if (sent && otherReadUpTo != null && m.id <= otherReadUpTo) {
        meta += '<span class="msg-read">âœ“âœ“</span>';
    }
    meta += '</div>';
    parts.push(meta);
    return '<div class="msg ' + cls + '" data-msg-id="' + (m.id || '') + '">' + parts.join('') + '</div>';
}
function formatDateSep(dateKey) {
    if (!dateKey) return '';
    var today = new Date().toISOString().slice(0, 10);
    var yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
    if (dateKey === today) return 'Ø§Ù…Ø±ÙˆØ²';
    if (dateKey === yesterday) return 'Ø¯ÛŒØ±ÙˆØ²';
    return dateKey;
}
function buildChatMessagesWithDateSep(messages, otherReadUpTo) {
    var out = [];
    var lastDate = '';
    for (var i = 0; i < messages.length; i++) {
        var m = messages[i];
        var dateKey = (m.created_at || '').toString().trim().slice(0, 10);
        if (dateKey && dateKey !== lastDate) {
            lastDate = dateKey;
            out.push('<div class="msg-date-sep"><span>' + escapeHtml(formatDateSep(dateKey)) + '</span></div>');
        }
        out.push(buildMessageHtml(m, otherReadUpTo));
    }
    return out.join('');
}

function loadChat(isPolling) {
    if (!currentOtherId) return;
    if (!isPolling) fetchOtherPublicKey(currentOtherId);
    var wasAtBottom = !isPolling || (chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 80);
    fetch('/api/chat/' + currentOtherId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                if (!isPolling) chatMessages.innerHTML = '<p class="error">' + escapeHtml(data.error) + '</p>';
                return;
            }
            var maxId = 0;
            data.messages.forEach(function(m) { if (m.id > maxId) maxId = m.id; });
            var sameContent = isPolling && data.messages.length === lastChatMessageCount && maxId === lastChatLastId;
            if (sameContent) {
                if (maxId > 0) {
                    fetch('/api/chat/' + currentOtherId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                        body: JSON.stringify({ read_receipt: true, last_read_message_id: maxId })
                    });
                }
                return;
            }
            var prevLastId = lastChatLastId;
            lastChatMessageCount = data.messages.length;
            lastChatLastId = maxId;
            iBlockedThem = data.i_blocked_them || false;
            if (blockBtn) {
                blockBtn.style.display = 'inline-flex';
                blockBtn.textContent = iBlockedThem ? 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª' : 'Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†';
            }
            var otherReadUpTo = data.other_read_up_to != null ? data.other_read_up_to : null;
            var messages = prepareE2eeMessages(data.messages, data.public_keys || {});
            chatMessages.innerHTML = buildChatMessagesWithDateSep(messages, otherReadUpTo);
            initVoiceBubbles();
            chatMessages.querySelectorAll('.msg-del').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var mid = parseInt(btn.getAttribute('data-msg-id'), 10);
                    if (mid !== mid) return;
                    fetch('/api/message/' + mid, {
                        method: 'DELETE',
                        headers: { 'X-CSRF-Token': csrfToken }
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        if (res.ok) {
                            var el = chatMessages.querySelector('.msg[data-msg-id="' + mid + '"]');
                            if (el) el.remove();
                        } else { showToast(res.error || 'Ø®Ø·Ø§'); }
                    });
                });
            });
            if (wasAtBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
            if (maxId > 0) {
                fetch('/api/chat/' + currentOtherId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ read_receipt: true, last_read_message_id: maxId })
                });
            }
            if (isPolling && prevLastId > 0 && typeof Notification !== 'undefined' && Notification.permission === 'granted' && document.hidden) {
                var newReceived = data.messages.filter(function(m) { return m.id > prevLastId && m.sender_id !== userId; });
                if (newReceived.length > 0) {
                    var fromName = (currentOtherName && currentOtherName.length > 0) ? currentOtherName : 'ÙØ±Ø³ØªÙ†Ø¯Ù‡';
                    var bodyText;
                    if (newReceived.length === 1) {
                        var msg = newReceived[0];
                        if (msg.message_type === 'image') bodyText = 'Ø¹Ú©Ø³';
                        else if (msg.message_type === 'voice') bodyText = 'ÙˆÛŒØ³';
                        else if (msg.message_type === 'file') bodyText = 'ÙØ§ÛŒÙ„';
                        else bodyText = (msg.body || '').trim().slice(0, 60) || 'Ù¾ÛŒØ§Ù…';
                        if ((msg.body || '').length > 60) bodyText += 'â€¦';
                    } else {
                        bodyText = newReceived.length + ' Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯';
                    }
                    try {
                        var n = new Notification('Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ' + fromName, { body: bodyText, dir: 'rtl', tag: 'msg-' + currentOtherId });
                        n.onclick = function() { window.focus(); n.close(); };
                    } catch (e) {}
                }
            }
            if (!isPolling) startChatPoll();
        });
}

if (blockBtn) {
    blockBtn.addEventListener('click', function() {
        if (!currentOtherId) return;
        var method = iBlockedThem ? 'DELETE' : 'POST';
        fetch('/api/block/' + currentOtherId, {
            method: method,
            headers: { 'X-CSRF-Token': csrfToken }
        }).then(function(r) { return r.json(); }).then(function(res) {
            if (res.ok) {
                iBlockedThem = !iBlockedThem;
                blockBtn.textContent = iBlockedThem ? 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª' : 'Ù…Ø³Ø¯ÙˆØ¯';
                showToast(iBlockedThem ? 'Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.' : 'Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ø´Ø¯.');
            } else { showToast(res.error || 'Ø®Ø·Ø§'); }
        });
    });
}

if (chatSearchToggle && chatSearchInChat && chatSearchInput) {
    chatSearchToggle.addEventListener('click', function() {
        chatSearchInChat.classList.toggle('visible');
        if (chatSearchInChat.classList.contains('visible')) {
            chatSearchInput.value = '';
            chatSearchInput.focus();
            chatMessages.querySelectorAll('.msg').forEach(function(m) { m.classList.remove('hidden-by-search'); });
        } else {
            chatMessages.querySelectorAll('.msg').forEach(function(m) { m.classList.remove('hidden-by-search'); });
        }
    });
    chatSearchInput.addEventListener('input', function() {
        var q = chatSearchInput.value.trim().toLowerCase();
        chatMessages.querySelectorAll('.msg').forEach(function(m) {
            m.classList.toggle('hidden-by-search', q.length > 0 && m.textContent.toLowerCase().indexOf(q) === -1);
        });
    });
}
if (chatClearChatBtn) {
    chatClearChatBtn.addEventListener('click', function() {
        if (!currentOtherId) return;
        if (!confirm('Ù‡Ù…Ù‡Ù” Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ (Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ø·Ø±Ù)')) return;
        fetch('/api/conversation/' + currentOtherId + '/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({ csrf_token: csrfToken })
        }).then(function(r) { return r.json(); }).then(function(res) {
            if (res.ok) {
                currentOtherId = null;
                currentOtherName = null;
                showView('list');
                loadConversations();
                showToast('Ú¯ÙØªÚ¯Ùˆ Ø­Ø°Ù Ø´Ø¯');
            } else { showToast(res.error || 'Ø®Ø·Ø§'); }
        });
    });
}

if (btnNotify) {
    btnNotify.addEventListener('click', function() {
        if (typeof Notification === 'undefined') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´Ù‡');
            return;
        }
        if (Notification.permission === 'granted') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø§Ø² Ù‚Ø¨Ù„ ÙØ¹Ø§Ù„ Ø§Ø³Øª');
            return;
        }
        if (Notification.permission === 'denied') {
            showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡. Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ù‡ÛŒØ¯.');
            return;
        }
        Notification.requestPermission().then(function(p) {
            if (p === 'granted') showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯');
            else if (p === 'denied') showToast('Ø§Ø¬Ø§Ø²Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯');
        });
    });
}

showView('list');
loadConversations();
loadGroupsList();
if (userId) uploadE2EEPublicKey();
if (joinError) showToast(joinError);
if (initialGroupId) {
    fetch('/api/groups/' + initialGroupId)
        .then(function(r) { return r.json(); })
        .then(function(g) {
            if (g && g.id) {
                currentGroupId = g.id;
                currentGroupName = g.name;
                currentGroupInviteCode = g.invite_code || null;
                showView('group');
                if (chatHeaderTitle) chatHeaderTitle.textContent = g.name;
                loadGroupChat();
                updateMicPermissionCard();
            }
        });
}

(function() {
    var PWA_DISMISS_KEY = 'pwa_install_dismissed';
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            (window.innerWidth <= 768 && 'ontouchstart' in window);
    }
    function isStandalone() {
        return window.matchMedia('(display-mode: standalone)').matches ||
            window.matchMedia('(display-mode: fullscreen)').matches ||
            (window.navigator.standalone === true);
    }
    function shouldShowInstallBanner() {
        return pwaInstallBanner && isMobile() && !isStandalone() && localStorage.getItem(PWA_DISMISS_KEY) !== '1';
    }
    var deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
    });
    if (pwaInstallDismiss) {
        pwaInstallDismiss.addEventListener('click', function() {
            localStorage.setItem(PWA_DISMISS_KEY, '1');
            if (pwaInstallBanner) pwaInstallBanner.classList.remove('visible');
        });
    }
    if (pwaInstallBtn) {
        pwaInstallBtn.addEventListener('click', function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choice) {
                    if (choice.outcome === 'accepted') {
                        showToast('Ù†ØµØ¨ Ø´Ø±ÙˆØ¹ Ø´Ø¯');
                    }
                    deferredPrompt = null;
                });
                if (pwaInstallBanner) pwaInstallBanner.classList.remove('visible');
                localStorage.setItem(PWA_DISMISS_KEY, '1');
            } else {
                showToast('Ø§Ø² Ù…Ù†ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± (â‹¯ ÛŒØ§ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ) Ú¯Ø²ÛŒÙ†Ù‡ Â«Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡Ù” Ø§ØµÙ„ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
            }
        });
    }
    if (shouldShowInstallBanner()) {
        setTimeout(function() {
            if (pwaInstallBanner && localStorage.getItem(PWA_DISMISS_KEY) !== '1') {
                pwaInstallBanner.classList.add('visible');
            }
        }, 2500);
    }
})();

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    var body = msgInput.value.trim();
    var btn = chatForm.querySelector('button[type="submit"]');

    if (currentGroupId) {
        if (selectedFile) {
            btn.disabled = true;
            var fd = new FormData();
            fd.append('file', selectedFile);
            fd.append('body', body);
            fd.append('csrf_token', csrfToken);
            try {
                var r = await fetch('/api/groups/' + currentGroupId + '/send', { method: 'POST', body: fd });
                var res = await r.json();
                if (res.ok) {
                    msgInput.value = '';
                    clearAttachmentStrip();
                    loadGroupChat();
                } else { showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„'); }
            } finally { btn.disabled = false; }
        } else {
            if (!body) return;
            btn.disabled = true;
            try {
                var r = await fetch('/api/groups/' + currentGroupId + '/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ body: body })
                });
                var res = await r.json();
                if (res.ok) { msgInput.value = ''; loadGroupChat(); }
                else { showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„'); }
            } finally { btn.disabled = false; }
            return;
        }
        return;
    }

    if (!currentOtherId) return;
    if (selectedFile) {
        btn.disabled = true;
        var fd = new FormData();
        fd.append('file', selectedFile);
        fd.append('receiver_id', currentOtherId);
        fd.append('body', body);
        fd.append('csrf_token', csrfToken);
        try {
            var r = await fetch('/api/send', { method: 'POST', body: fd });
            var res = await r.json();
            if (res.ok) {
                msgInput.value = '';
                clearAttachmentStrip();
                loadChat();
            } else { showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„'); }
        } finally { btn.disabled = false; }
        return;
    }
    if (!body) return;
    btn.disabled = true;
    try {
        var otherPub = otherPublicKeyByUserId[currentOtherId];
        var payload;
        if (otherPub && typeof encryptE2eeBody === 'function') {
            var cipher = encryptE2eeBody(body, otherPub);
            if (cipher) {
                payload = JSON.stringify({ receiver_id: currentOtherId, e2ee_ciphertext: cipher });
            } else {
                payload = JSON.stringify({ receiver_id: currentOtherId, body: body });
            }
        } else {
            payload = JSON.stringify({ receiver_id: currentOtherId, body: body });
        }
        var r = await fetch('/api/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: payload
        });
        var res = await r.json();
        if (res.ok) { msgInput.value = ''; loadChat(); }
        else { showToast(res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„'); }
    } finally { btn.disabled = false; }
});
</script>
{% endblock %}

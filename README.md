# مسنجر تحت وب (E2EE)

مسنجر تحت وب با پایتون و فلاسک، پنل مدیریت برای کاربران و **رمزنگاری انتها‑به‑انتها (E2EE)** برای چت دو نفره (مشابه چت مخفی تلگرام).

## قابلیت‌ها

- **ورود دو نوع**: ورود به عنوان **ادمین** یا **کاربر عادی**
- **پنل ادمین**: فقط ادمین می‌تواند کاربر جدید اضافه کند و لیست کاربران را ببیند
- **مسنجر**: کاربران فقط با کاربران اضافه‌شده توسط ادمین می‌توانند چت کنند
- **E2EE برای چت دو نفره**: پیام‌های متنی در چت دو نفره در مرورگر رمزنگاری می‌شوند (Curve25519 + NaCl)؛ سرور فقط دادهٔ رمزشده را ذخیره می‌کند و **نمی‌تواند محتوا را بخواند**. پیام‌های قدیمی و گروه‌ها همچنان با رمزنگاری سرور (Fernet) ذخیره می‌شوند.

## نصب و اجرا

```bash
cd /home/hossein/python/messanger
python3 -m venv venv
source venv/bin/activate   # در ویندوز: venv\Scripts\activate
pip install -r requirements.txt
python app.py
```

مرورگر: **http://127.0.0.1:5000**

## ورود اولیه ادمین

- **نام کاربری**: `admin`
- **رمز عبور**: `admin123`

حتماً در محیط واقعی این رمز را عوض کنید (با تغییر مستقیم در دیتابیس یا اضافه کردن قابلیت تغییر رمز ادمین).

## نصب به‌صورت وب‌اپ روی موبایل (PWA)

- مسنجر یک **وب‌اپ قابل نصب** است (مانیفست در `static/manifest.json`).
- روی موبایل از منوی مرورگر گزینه **«افزودن به صفحهٔ اصلی»** یا **«نصب اپ»** را بزنید.
- **ضبط ویس (میکروفون)** فقط در محیط امن کار می‌کند: یعنی **HTTPS** یا localhost. اگر با آدرس http (مثلاً روی شبکه محلی) باز کنید، مرورگر دسترسی میکروفون را نمی‌دهد. برای استفاده روی موبایل، سایت را حتماً با HTTPS سرو کنید و در صورت نیاز وب‌اپ را نصب کنید.

## تنظیمات پروداکشن

- **HTTPS**: در پروداکشن سرور را پشت HTTPS (مثلاً با nginx و Let's Encrypt) قرار دهید تا ارتباط تحت وب هم رمزنگاری شود و ضبط ویس و نصب PWA روی موبایل درست کار کند.
- **SECRET_KEY**: متغیر محیطی `SECRET_KEY` را تنظیم کنید.
- **FERNET_KEY**: برای رمزنگاری پیام‌ها می‌توانید یک کلید ثابت بگذارید تا بعد از ریست سرور هم پیام‌ها قابل خواندن باشند:
  ```python
  from cryptography.fernet import Fernet
  print(Fernet.generate_key().decode())
  ```
  خروجی را در `FERNET_KEY` قرار دهید.

## ساختار پروژه

- `app.py` — برنامه فلاسک و مسیرها (شامل API کلیدهای E2EE و ارسال/دریافت پیام E2EE)
- `db.py` — دیتابیس، احراز هویت، جدول `user_public_keys` و پرچم `is_e2ee` برای پیام‌ها
- `crypto_util.py` — رمزنگاری سرور (Fernet) برای پیام‌های غیر E2EE و مدیا
- `config.py` — تنظیمات و کلیدها
- `templates/` — قالب‌های HTML (E2EE در کلاینت با TweetNaCl)
